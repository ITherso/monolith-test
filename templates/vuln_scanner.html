{% extends "base.html" %}

{% block body %}
<div class="min-h-screen">
    <!-- Background Effects -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-blue-500/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-cyan-500/10 rounded-full blur-3xl"></div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <a href="/" class="w-12 h-12 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center transition-colors">
                        <i class="fas fa-arrow-left text-gray-400"></i>
                    </a>
                    <div>
                        <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                            <i class="fas fa-search text-blue-500"></i>
                            AUTOMATED VULNERABILITY SCANNER
                            <span class="px-3 py-1 text-sm bg-blue-500/20 text-blue-400 rounded-full">NEW</span>
                        </h1>
                        <p class="text-gray-400 mt-1">Multi-Scanner Integration with AI Priority Ranking</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div id="statusIndicator" class="glass rounded-xl px-4 py-2 flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-gray-500"></div>
                        <span class="text-gray-400 text-sm">Idle</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scanner Configuration -->
        <div class="glass rounded-2xl p-6 mb-8">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                <i class="fas fa-cog text-blue-500"></i>
                Scan Configuration
            </h2>

            <form id="scanForm" class="space-y-6">
                <!-- Target Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">
                        <i class="fas fa-bullseye text-blue-500 mr-2"></i>
                        Target URL or IP Address
                    </label>
                    <input type="text" id="targetInput" required
                           class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 transition-all font-mono"
                           placeholder="https://example.com or 192.168.1.100">
                </div>

                <!-- Scanner Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3">
                        <i class="fas fa-tools text-cyan-500 mr-2"></i>
                        Select Scanners (Leave empty for all)
                    </label>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                        {% for scanner in available_scanners %}
                        <label class="glass rounded-xl p-3 cursor-pointer hover:bg-white/5 transition-all border border-white/10 hover:border-blue-500/30">
                            <input type="checkbox" name="scanners" value="{{ scanner.type }}" 
                                   class="w-4 h-4 rounded border-white/20 bg-white/5 text-blue-500 focus:ring-blue-500/50 mr-2">
                            <span class="text-gray-300 text-sm">{{ scanner.name }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    {% if not available_scanners %}
                    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                        <p class="text-yellow-400 text-sm">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            No scanners detected. Please install: nuclei, owasp-zap, nikto, sqlmap, nmap
                        </p>
                    </div>
                    {% endif %}
                </div>

                <!-- Scan Type -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Scan Type</label>
                        <select id="scanType" class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white focus:outline-none focus:border-blue-500/50">
                            <option value="quick">Quick Scan (5-10 min)</option>
                            <option value="full" selected>Full Scan (15-30 min)</option>
                            <option value="deep">Deep Scan (30-60 min)</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2 flex items-end">
                        <button type="submit" class="w-full px-6 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold hover:from-blue-600 hover:to-cyan-600 transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20">
                            <i class="fas fa-play"></i>
                            Start Vulnerability Scan
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Scan Progress -->
        <div id="scanProgress" class="glass rounded-2xl p-6 mb-8 hidden">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                <i class="fas fa-spinner fa-spin text-blue-500"></i>
                Scanning in Progress
            </h2>

            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-gray-300">Target:</span>
                    <span id="progressTarget" class="text-white font-mono"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-300">Job ID:</span>
                    <span id="progressJobId" class="text-blue-400 font-mono text-sm"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-300">Status:</span>
                    <span id="progressStatus" class="text-yellow-400">Running...</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-300">Duration:</span>
                    <span id="progressDuration" class="text-white">0s</span>
                </div>
            </div>
        </div>

        <!-- Results Dashboard -->
        <div id="resultsSection" class="hidden">
            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass rounded-2xl p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Critical</span>
                        <i class="fas fa-exclamation-circle text-red-500"></i>
                    </div>
                    <div id="criticalCount" class="text-3xl font-bold text-red-500">0</div>
                </div>

                <div class="glass rounded-2xl p-6 border-l-4 border-orange-500">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">High</span>
                        <i class="fas fa-exclamation-triangle text-orange-500"></i>
                    </div>
                    <div id="highCount" class="text-3xl font-bold text-orange-500">0</div>
                </div>

                <div class="glass rounded-2xl p-6 border-l-4 border-yellow-500">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Medium</span>
                        <i class="fas fa-info-circle text-yellow-500"></i>
                    </div>
                    <div id="mediumCount" class="text-3xl font-bold text-yellow-500">0</div>
                </div>

                <div class="glass rounded-2xl p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Total</span>
                        <i class="fas fa-list text-blue-500"></i>
                    </div>
                    <div id="totalCount" class="text-3xl font-bold text-white">0</div>
                </div>
            </div>

            <!-- Vulnerabilities List -->
            <div class="glass rounded-2xl p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-bug text-red-500"></i>
                        Discovered Vulnerabilities
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="exportReport('json')" class="px-4 py-2 rounded-lg bg-blue-500/20 text-blue-400 hover:bg-blue-500/30 transition-all text-sm">
                            <i class="fas fa-download mr-2"></i>JSON
                        </button>
                        <button onclick="exportReport('html')" class="px-4 py-2 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 transition-all text-sm">
                            <i class="fas fa-file-code mr-2"></i>HTML
                        </button>
                    </div>
                </div>

                <!-- Filter -->
                <div class="mb-4">
                    <select id="severityFilter" onchange="filterVulnerabilities()" class="px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm">
                        <option value="">All Severities</option>
                        <option value="critical">Critical Only</option>
                        <option value="high">High Only</option>
                        <option value="medium">Medium Only</option>
                        <option value="low">Low Only</option>
                    </select>
                </div>

                <div id="vulnerabilitiesList" class="space-y-4">
                    <!-- Will be populated via JavaScript -->
                </div>
            </div>

            <!-- Heatmap -->
            <div class="glass rounded-2xl p-6">
                <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i class="fas fa-chart-bar text-purple-500"></i>
                    Vulnerability Heatmap
                </h2>
                <div id="heatmapContainer">
                    <canvas id="heatmapChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentJobId = null;
let pollInterval = null;
let startTime = null;

document.getElementById('scanForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const target = document.getElementById('targetInput').value;
    const scanType = document.getElementById('scanType').value;
    const scanners = Array.from(document.querySelectorAll('input[name="scanners"]:checked'))
                          .map(cb => cb.value);
    
    try {
        const response = await fetch('/tools/api/vuln-scanner/scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ target, scanners, scan_type: scanType })
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentJobId = data.job_id;
            startTime = Date.now();
            
            // Show progress
            document.getElementById('scanProgress').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('progressTarget').textContent = target;
            document.getElementById('progressJobId').textContent = data.job_id;
            
            // Update status indicator
            document.getElementById('statusIndicator').innerHTML = `
                <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
                <span class="text-blue-400 text-sm">Scanning</span>
            `;
            
            // Start polling
            pollInterval = setInterval(checkScanStatus, 3000);
        } else {
            alert('Scan failed: ' + data.error);
        }
    } catch (error) {
        alert('Error starting scan: ' + error);
    }
});

async function checkScanStatus() {
    if (!currentJobId) return;
    
    try {
        const response = await fetch(`/tools/api/vuln-scanner/status/${currentJobId}`);
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('progressStatus').textContent = data.status;
            
            // Update duration
            const duration = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('progressDuration').textContent = `${duration}s`;
            
            if (data.status === 'completed') {
                clearInterval(pollInterval);
                loadResults();
                
                // Update status indicator
                document.getElementById('statusIndicator').innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span class="text-green-400 text-sm">Completed</span>
                `;
            } else if (data.status === 'failed') {
                clearInterval(pollInterval);
                alert('Scan failed!');
                
                // Update status indicator
                document.getElementById('statusIndicator').innerHTML = `
                    <div class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span class="text-red-400 text-sm">Failed</span>
                `;
            }
        }
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

async function loadResults() {
    if (!currentJobId) return;
    
    try {
        // Load vulnerabilities
        const vulnsResponse = await fetch(`/tools/api/vuln-scanner/results/${currentJobId}`);
        const vulnsData = await vulnsResponse.json();
        
        // Load heatmap
        const heatmapResponse = await fetch(`/tools/api/vuln-scanner/heatmap/${currentJobId}`);
        const heatmapData = await heatmapResponse.json();
        
        // Hide progress, show results
        document.getElementById('scanProgress').classList.add('hidden');
        document.getElementById('resultsSection').classList.remove('hidden');
        
        // Update summary
        const heatmap = heatmapData.heatmap;
        document.getElementById('criticalCount').textContent = heatmap.severity_distribution.critical;
        document.getElementById('highCount').textContent = heatmap.severity_distribution.high;
        document.getElementById('mediumCount').textContent = heatmap.severity_distribution.medium;
        document.getElementById('totalCount').textContent = heatmap.total_vulnerabilities;
        
        // Display vulnerabilities
        displayVulnerabilities(vulnsData.vulnerabilities);
        
        // Render heatmap chart
        renderHeatmap(heatmap);
        
    } catch (error) {
        console.error('Error loading results:', error);
    }
}

function displayVulnerabilities(vulnerabilities) {
    const container = document.getElementById('vulnerabilitiesList');
    container.innerHTML = '';
    
    if (vulnerabilities.length === 0) {
        container.innerHTML = '<div class="text-center text-gray-400 py-8">No vulnerabilities found</div>';
        return;
    }
    
    vulnerabilities.forEach(vuln => {
        const severityColors = {
            critical: 'red',
            high: 'orange',
            medium: 'yellow',
            low: 'blue',
            info: 'gray'
        };
        
        const color = severityColors[vuln.severity] || 'gray';
        
        const vulnCard = document.createElement('div');
        vulnCard.className = `glass rounded-xl p-4 border-l-4 border-${color}-500`;
        vulnCard.innerHTML = `
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <h3 class="text-white font-bold text-lg mb-1">${vuln.title}</h3>
                    <p class="text-gray-400 text-sm">${vuln.description}</p>
                </div>
                <span class="px-3 py-1 rounded-full bg-${color}-500/20 text-${color}-400 text-sm font-bold uppercase ml-4">
                    ${vuln.severity}
                </span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-gray-500">Type:</span>
                    <span class="text-white ml-2">${vuln.vuln_type}</span>
                </div>
                <div>
                    <span class="text-gray-500">CVSS:</span>
                    <span class="text-${color}-400 ml-2 font-bold">${vuln.cvss_score}</span>
                </div>
                <div>
                    <span class="text-gray-500">Scanner:</span>
                    <span class="text-white ml-2">${vuln.scanner}</span>
                </div>
                <div>
                    <span class="text-gray-500">Priority:</span>
                    <span class="text-purple-400 ml-2 font-bold">${Math.round(vuln.ai_priority_score * 100)}%</span>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-white/10">
                <div class="text-gray-500 text-xs mb-1">Target URL:</div>
                <div class="text-cyan-400 text-sm font-mono">${vuln.target_url}</div>
            </div>
        `;
        
        container.appendChild(vulnCard);
    });
}

function renderHeatmap(heatmap) {
    // Simple text-based heatmap for now
    const container = document.getElementById('heatmapContainer');
    container.innerHTML = `
        <div class="space-y-4">
            <div>
                <h4 class="text-white font-semibold mb-2">Severity Distribution</h4>
                <div class="space-y-2">
                    ${Object.entries(heatmap.severity_distribution).map(([severity, count]) => `
                        <div class="flex items-center gap-3">
                            <span class="text-gray-400 w-20 text-sm capitalize">${severity}</span>
                            <div class="flex-1 h-8 bg-white/5 rounded-lg overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-${getSeverityColor(severity)}-500/50 to-${getSeverityColor(severity)}-500" 
                                     style="width: ${(count / heatmap.total_vulnerabilities * 100)}%"></div>
                            </div>
                            <span class="text-white font-bold w-12 text-right">${count}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div>
                <h4 class="text-white font-semibold mb-2">Vulnerability Types</h4>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    ${Object.entries(heatmap.type_distribution).map(([type, count]) => `
                        <div class="glass rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-400">${count}</div>
                            <div class="text-xs text-gray-400 mt-1">${type.replace(/_/g, ' ')}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
}

function getSeverityColor(severity) {
    const colors = {
        critical: 'red',
        high: 'orange',
        medium: 'yellow',
        low: 'blue',
        info: 'gray'
    };
    return colors[severity] || 'gray';
}

function filterVulnerabilities() {
    // Reload with filter
    const severity = document.getElementById('severityFilter').value;
    if (severity) {
        loadFilteredResults(severity);
    } else {
        loadResults();
    }
}

async function loadFilteredResults(severity) {
    if (!currentJobId) return;
    
    try {
        const response = await fetch(`/tools/api/vuln-scanner/results/${currentJobId}?severity=${severity}`);
        const data = await response.json();
        displayVulnerabilities(data.vulnerabilities);
    } catch (error) {
        console.error('Error loading filtered results:', error);
    }
}

function exportReport(format) {
    if (!currentJobId) return;
    window.open(`/tools/api/vuln-scanner/report/${currentJobId}?format=${format}`, '_blank');
}
</script>

{% endblock %}
